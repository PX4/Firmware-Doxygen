<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PX4 Firmware: src/lib/ecl/tecs/tecs.cpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">PX4 Firmware
   </div>
   <div id="projectbrief">PX4 Autopilot Software http://px4.io</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('db/da1/tecs_8cpp_source.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">tecs.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../db/da1/tecs_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/****************************************************************************</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> *   Copyright (c) 2017 Estimation and Control Library (ECL). All rights reserved.</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> * Redistribution and use in source and binary forms, with or without</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> * modification, are permitted provided that the following conditions</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> * are met:</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> * 1. Redistributions of source code must retain the above copyright</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> *    notice, this list of conditions and the following disclaimer.</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> *    notice, this list of conditions and the following disclaimer in</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> *    the documentation and/or other materials provided with the</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> *    distribution.</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> * 3. Neither the name ECL nor the names of its contributors may be</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> *    used to endorse or promote products derived from this software</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"> *    without specific prior written permission.</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE</span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment"> * COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN</span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment"> * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment"> * POSSIBILITY OF SUCH DAMAGE.</span></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment"> ****************************************************************************/</span></div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d6/d35/tecs_8h.html">tecs.h</a>&quot;</span></div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="../../d2/d53/ecl_8h.html">ecl.h</a>&gt;</span></div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="../../db/d35/geo_8h.html">geo/geo.h</a>&gt;</span></div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="keyword">using</span> <a class="code" href="../../dd/d47/namespacemath.html#a4a49a65edaf29055a3cb021908a031d7">math::constrain</a>;</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="keyword">using</span> <a class="code" href="../../dd/d47/namespacemath.html#ad42187b143e9e0e96bb14c7edcfbfef6">math::max</a>;</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="keyword">using</span> <a class="code" href="../../dd/d47/namespacemath.html#a0590ec5bbbdad228b5a47307af425055">math::min</a>;</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div><div class="line"><a name="l00043"></a><span class="lineno"><a class="line" href="../../db/da1/tecs_8cpp.html#a31dce443d7ddc17762497a06a865d8b6">   43</a></span>&#160;<span class="keyword">static</span> constexpr <span class="keywordtype">float</span> <a class="code" href="../../db/da1/tecs_8cpp.html#a31dce443d7ddc17762497a06a865d8b6">DT_MIN</a> = 0.001f; <span class="comment">///&lt; minimum allowed value of _dt (sec)</span></div><div class="line"><a name="l00044"></a><span class="lineno"><a class="line" href="../../db/da1/tecs_8cpp.html#a85417aeee491c2add265c8041e690ec0">   44</a></span>&#160;<span class="comment"></span><span class="keyword">static</span> constexpr <span class="keywordtype">float</span> <a class="code" href="../../db/da1/tecs_8cpp.html#a85417aeee491c2add265c8041e690ec0">DT_MAX</a> = 1.0f;   <span class="comment">///&lt; max value of _dt allowed before a filter state reset is performed (sec)</span></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment"></span><span class="comment"></span></div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="comment">/**</span></div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="comment"> * @file tecs.cpp</span></div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="comment"> * @author Paul Riseborough</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="comment"> * This function implements a complementary filter to estimate the climb rate when</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="comment"> * inertial nav data is not available. It also calculates a true airspeed derivative</span></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="comment"> * which is used by the airspeed complimentary filter.</span></div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00057"></a><span class="lineno"><a class="line" href="../../d1/d1f/class_t_e_c_s.html#aab6412a9450a4430487b7b1cffa7c38f">   57</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aab6412a9450a4430487b7b1cffa7c38f">TECS::update_vehicle_state_estimates</a>(<span class="keywordtype">float</span> airspeed, <span class="keyword">const</span> <a class="code" href="../../d4/d11/classmatrix_1_1_dcm.html">matrix::Dcmf</a> &amp;rotMat,</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;        <span class="keyword">const</span> <a class="code" href="../../d3/d87/classmatrix_1_1_vector3.html">matrix::Vector3f</a> &amp;accel_body, <span class="keywordtype">bool</span> altitude_lock, <span class="keywordtype">bool</span> in_air,</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;        <span class="keywordtype">float</span> altitude, <span class="keywordtype">bool</span> vz_valid, <span class="keywordtype">float</span> vz, <span class="keywordtype">float</span> az)</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;{</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    <span class="comment">// calculate the time lapsed since the last update</span></div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    uint64_t now = <a class="code" href="../../d2/d53/ecl_8h.html#aea508d88b103ed107003d0a4b582b257">ecl_absolute_time</a>();</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    <span class="keywordtype">float</span> <a class="code" href="../../dd/d87/px4io_8c.html#a778e38aa889751afffa2dea6b803e67a">dt</a> = <a class="code" href="../../dd/d47/namespacemath.html#a4a49a65edaf29055a3cb021908a031d7">constrain</a>((now - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a7a2699e5cf8e98357087943d536277c2">_state_update_timestamp</a>) * 1.0e-6<a class="code" href="../../d8/da1/integration_8cpp.html#af5ba872dd09316732300733cc164ac1a">f</a>, <a class="code" href="../../db/da1/tecs_8cpp.html#a31dce443d7ddc17762497a06a865d8b6">DT_MIN</a>, <a class="code" href="../../db/da1/tecs_8cpp.html#a85417aeee491c2add265c8041e690ec0">DT_MAX</a>);</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <span class="keywordtype">bool</span> reset_altitude = <span class="keyword">false</span>;</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a7a2699e5cf8e98357087943d536277c2">_state_update_timestamp</a> == 0 || dt &gt; <a class="code" href="../../db/da1/tecs_8cpp.html#a85417aeee491c2add265c8041e690ec0">DT_MAX</a>) {</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;        dt = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a9d91854786fdf8697c224df982f4ba5c">DT_DEFAULT</a>;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;        reset_altitude = <span class="keyword">true</span>;</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    }</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    <span class="keywordflow">if</span> (!altitude_lock || !in_air) {</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;        reset_altitude = <span class="keyword">true</span>;</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    }</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    <span class="keywordflow">if</span> (reset_altitude) {</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ae680021e0c92c9da05429c915b415d7e">_vert_pos_state</a> = altitude;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;        <span class="keywordflow">if</span> (vz_valid) {</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;            <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a7a4184c3a5c301b95e93b3ca9bf26dd7">_vert_vel_state</a> = -vz;</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;            <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a7a4184c3a5c301b95e93b3ca9bf26dd7">_vert_vel_state</a> = 0.0f;</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;        }</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ac9dffa45ad1bfadc69e5e3b75e2de25d">_vert_accel_state</a> = 0.0f;</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a06802c5fc4a2aee207156706117d889d">_states_initalized</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    }</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a7a2699e5cf8e98357087943d536277c2">_state_update_timestamp</a> = now;</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ad3a8467e9cf0fd678c9cd4489c37419c">_EAS</a> = airspeed;</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a4323d25b277e12fd373be58e3110cdab">_in_air</a> = in_air;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    <span class="comment">// Generate the height and climb rate state estimates</span></div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    <span class="keywordflow">if</span> (vz_valid) {</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;        <span class="comment">// Set the velocity and position state to the the INS data</span></div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a7a4184c3a5c301b95e93b3ca9bf26dd7">_vert_vel_state</a> = -vz;</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ae680021e0c92c9da05429c915b415d7e">_vert_pos_state</a> = altitude;</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;        <span class="comment">// Get height acceleration</span></div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;        <span class="keywordtype">float</span> hgt_ddot_mea = -az;</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;        <span class="comment">// If we have no vertical INS data, estimate the vertical velocity using a complementary filter</span></div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;        <span class="comment">// Perform filter calculation using backwards Euler integration</span></div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;        <span class="comment">// Coefficients selected to place all three filter poles at omega</span></div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        <span class="comment">// Reference Paper: Optimising the Gains of the Baro-Inertial Vertical Channel</span></div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;        <span class="comment">// Widnall W.S, Sinha P.K, AIAA Journal of Guidance and Control, 78-1307R</span></div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        <span class="keywordtype">float</span> omega2 = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ab03d4d09d85e595746b83c89d845d01d">_hgt_estimate_freq</a> * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ab03d4d09d85e595746b83c89d845d01d">_hgt_estimate_freq</a>;</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;        <span class="keywordtype">float</span> hgt_err = altitude - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ae680021e0c92c9da05429c915b415d7e">_vert_pos_state</a>;</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;        <span class="keywordtype">float</span> vert_accel_input = hgt_err * omega2 * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ab03d4d09d85e595746b83c89d845d01d">_hgt_estimate_freq</a>;</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ac9dffa45ad1bfadc69e5e3b75e2de25d">_vert_accel_state</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ac9dffa45ad1bfadc69e5e3b75e2de25d">_vert_accel_state</a> + vert_accel_input * <a class="code" href="../../dd/d87/px4io_8c.html#a778e38aa889751afffa2dea6b803e67a">dt</a>;</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        <span class="keywordtype">float</span> vert_vel_input = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ac9dffa45ad1bfadc69e5e3b75e2de25d">_vert_accel_state</a> + hgt_ddot_mea + hgt_err * omega2 * 3.0f;</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a7a4184c3a5c301b95e93b3ca9bf26dd7">_vert_vel_state</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a7a4184c3a5c301b95e93b3ca9bf26dd7">_vert_vel_state</a> + vert_vel_input * <a class="code" href="../../dd/d87/px4io_8c.html#a778e38aa889751afffa2dea6b803e67a">dt</a>;</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        <span class="keywordtype">float</span> vert_pos_input = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a7a4184c3a5c301b95e93b3ca9bf26dd7">_vert_vel_state</a> + hgt_err * _hgt_estimate_freq * 3.0f;</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;        <span class="comment">// If more than 1 second has elapsed since last update then reset the position state</span></div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;        <span class="comment">// to the measured height</span></div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        <span class="keywordflow">if</span> (reset_altitude) {</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;            _vert_pos_state = altitude;</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;            _vert_pos_state = _vert_pos_state + vert_pos_input * <a class="code" href="../../dd/d87/px4io_8c.html#a778e38aa889751afffa2dea6b803e67a">dt</a>;</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;        }</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    }</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    <span class="comment">// Update and average speed rate of change if airspeed is being measured</span></div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d2/d53/ecl_8h.html#a5181155e284a192217ea7e0ea70bb810">ISFINITE</a>(airspeed) &amp;&amp; <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aecdf93951f7e0e7d056383826debfcf6">airspeed_sensor_enabled</a>()) {</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        <span class="comment">// Assuming the vehicle is flying X axis forward, use the X axis measured acceleration</span></div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        <span class="comment">// compensated for gravity to estimate the rate of change of speed</span></div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;        <span class="keywordtype">float</span> speed_deriv_raw = rotMat(2, 0) * <a class="code" href="../../db/d35/geo_8h.html#a32a64125a796fad5c13297499d50b082">CONSTANTS_ONE_G</a> + accel_body(0);</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        <span class="comment">// Apply some noise filtering</span></div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a2cd6cd2c99aac892c8cc41a0392dba92">_speed_derivative</a> = 0.95f * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a2cd6cd2c99aac892c8cc41a0392dba92">_speed_derivative</a> + 0.05f * speed_deriv_raw;</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a2cd6cd2c99aac892c8cc41a0392dba92">_speed_derivative</a> = 0.0f;</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    }</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a4323d25b277e12fd373be58e3110cdab">_in_air</a>) {</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a06802c5fc4a2aee207156706117d889d">_states_initalized</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    }</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;}</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;</div><div class="line"><a name="l00149"></a><span class="lineno"><a class="line" href="../../d1/d1f/class_t_e_c_s.html#ad80df2b3b140f116e244b619687f5033">  149</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ad80df2b3b140f116e244b619687f5033">TECS::_update_speed_states</a>(<span class="keywordtype">float</span> airspeed_setpoint, <span class="keywordtype">float</span> indicated_airspeed, <span class="keywordtype">float</span> EAS2TAS)</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;{</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    <span class="comment">// Calculate the time in seconds since the last update and use the default time step value if out of bounds</span></div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    uint64_t now = <a class="code" href="../../d2/d53/ecl_8h.html#aea508d88b103ed107003d0a4b582b257">ecl_absolute_time</a>();</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../dd/d87/px4io_8c.html#a778e38aa889751afffa2dea6b803e67a">dt</a> = <a class="code" href="../../dd/d47/namespacemath.html#a4a49a65edaf29055a3cb021908a031d7">constrain</a>((now - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a7b265b047753556de1e3fb8ee54987e0">_speed_update_timestamp</a>) * 1.0e-6<a class="code" href="../../d8/da1/integration_8cpp.html#af5ba872dd09316732300733cc164ac1a">f</a>, <a class="code" href="../../db/da1/tecs_8cpp.html#a31dce443d7ddc17762497a06a865d8b6">DT_MIN</a>, <a class="code" href="../../db/da1/tecs_8cpp.html#a85417aeee491c2add265c8041e690ec0">DT_MAX</a>);</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    <span class="comment">// Convert equivalent airspeed quantities to true airspeed</span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a65589176395cccd296be86762d2f336f">_EAS_setpoint</a> = airspeed_setpoint;</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a247b49471892cbe8a414d5981944b639">_TAS_setpoint</a>  = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a65589176395cccd296be86762d2f336f">_EAS_setpoint</a> * EAS2TAS;</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a0d597bd2728311e9804ea8b1ef1f5efa">_TAS_max</a>   = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a03cda9f2d349d699568bc78dec8db447">_indicated_airspeed_max</a> * EAS2TAS;</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a18296ff6e8c3066645c4ad2f4b1fdc48">_TAS_min</a>   = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a96d6a8a91a38a92ba9324210fb3416f1">_indicated_airspeed_min</a> * EAS2TAS;</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    <span class="comment">// If airspeed measurements are not being used, fix the airspeed estimate to halfway between</span></div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    <span class="comment">// min and max limits</span></div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d53/ecl_8h.html#a5181155e284a192217ea7e0ea70bb810">ISFINITE</a>(indicated_airspeed) || !<a class="code" href="../../d1/d1f/class_t_e_c_s.html#aecdf93951f7e0e7d056383826debfcf6">airspeed_sensor_enabled</a>()) {</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ad3a8467e9cf0fd678c9cd4489c37419c">_EAS</a> = 0.5f * (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a96d6a8a91a38a92ba9324210fb3416f1">_indicated_airspeed_min</a> + <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a03cda9f2d349d699568bc78dec8db447">_indicated_airspeed_max</a>);</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ad3a8467e9cf0fd678c9cd4489c37419c">_EAS</a> = indicated_airspeed;</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    }</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    <span class="comment">// If first time through or not flying, reset airspeed states</span></div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a7b265b047753556de1e3fb8ee54987e0">_speed_update_timestamp</a> == 0 || !<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a4323d25b277e12fd373be58e3110cdab">_in_air</a>) {</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ab8e692959353fac04c1e2b4b62f06425">_tas_rate_state</a> = 0.0f;</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a63dc43165dd4662b98e51f5ac87d15f0">_tas_state</a> = (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#ad3a8467e9cf0fd678c9cd4489c37419c">_EAS</a> * EAS2TAS);</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    }</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    <span class="comment">// Obtain a smoothed airspeed estimate using a second order complementary filter</span></div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    <span class="comment">// Update TAS rate state</span></div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    <span class="keywordtype">float</span> tas_error = (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#ad3a8467e9cf0fd678c9cd4489c37419c">_EAS</a> * EAS2TAS) - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a63dc43165dd4662b98e51f5ac87d15f0">_tas_state</a>;</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    <span class="keywordtype">float</span> tas_rate_state_input = tas_error * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aa4b4c2be7382fc9e4b89467549273222">_tas_estimate_freq</a> * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aa4b4c2be7382fc9e4b89467549273222">_tas_estimate_freq</a>;</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    <span class="comment">// limit integrator input to prevent windup</span></div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a63dc43165dd4662b98e51f5ac87d15f0">_tas_state</a> &lt; 3.1<a class="code" href="../../d8/da1/integration_8cpp.html#af5ba872dd09316732300733cc164ac1a">f</a>) {</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        tas_rate_state_input = <a class="code" href="../../dd/d47/namespacemath.html#ad42187b143e9e0e96bb14c7edcfbfef6">max</a>(tas_rate_state_input, 0.0<a class="code" href="../../d8/da1/integration_8cpp.html#af5ba872dd09316732300733cc164ac1a">f</a>);</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    }</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    <span class="comment">// Update TAS state</span></div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ab8e692959353fac04c1e2b4b62f06425">_tas_rate_state</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ab8e692959353fac04c1e2b4b62f06425">_tas_rate_state</a> + tas_rate_state_input * <a class="code" href="../../dd/d87/px4io_8c.html#a778e38aa889751afffa2dea6b803e67a">dt</a>;</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    <span class="keywordtype">float</span> tas_state_input = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ab8e692959353fac04c1e2b4b62f06425">_tas_rate_state</a> + <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a2cd6cd2c99aac892c8cc41a0392dba92">_speed_derivative</a> + tas_error * _tas_estimate_freq * 1.4142f;</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a63dc43165dd4662b98e51f5ac87d15f0">_tas_state</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a63dc43165dd4662b98e51f5ac87d15f0">_tas_state</a> + tas_state_input * <a class="code" href="../../dd/d87/px4io_8c.html#a778e38aa889751afffa2dea6b803e67a">dt</a>;</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <span class="comment">// Limit the airspeed state to a minimum of 3 m/s</span></div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a63dc43165dd4662b98e51f5ac87d15f0">_tas_state</a> = <a class="code" href="../../dd/d47/namespacemath.html#ad42187b143e9e0e96bb14c7edcfbfef6">max</a>(<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a63dc43165dd4662b98e51f5ac87d15f0">_tas_state</a>, 3.0<a class="code" href="../../d8/da1/integration_8cpp.html#af5ba872dd09316732300733cc164ac1a">f</a>);</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a7b265b047753556de1e3fb8ee54987e0">_speed_update_timestamp</a> = now;</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;}</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;</div><div class="line"><a name="l00199"></a><span class="lineno"><a class="line" href="../../d1/d1f/class_t_e_c_s.html#af1b423dec94a3bee2c7951e2c20fc9a8">  199</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../d1/d1f/class_t_e_c_s.html#af1b423dec94a3bee2c7951e2c20fc9a8">TECS::_update_speed_setpoint</a>()</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;{</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    <span class="comment">// Set the airspeed demand to the minimum value if an underspeed or</span></div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    <span class="comment">// or a uncontrolled descent condition exists to maximise climb rate</span></div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d1f/class_t_e_c_s.html#aca64b0d6f48ae591bf07a138a90ddfa3">_uncommanded_descent_recovery</a>) || (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#ab809ed3eda881d853dc4b2a8b4db3bc1">_underspeed_detected</a>)) {</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a247b49471892cbe8a414d5981944b639">_TAS_setpoint</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a18296ff6e8c3066645c4ad2f4b1fdc48">_TAS_min</a>;</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    }</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a247b49471892cbe8a414d5981944b639">_TAS_setpoint</a> = <a class="code" href="../../dd/d47/namespacemath.html#a4a49a65edaf29055a3cb021908a031d7">constrain</a>(<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a247b49471892cbe8a414d5981944b639">_TAS_setpoint</a>, <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a18296ff6e8c3066645c4ad2f4b1fdc48">_TAS_min</a>, <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a0d597bd2728311e9804ea8b1ef1f5efa">_TAS_max</a>);</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    <span class="comment">// Calculate limits for the demanded rate of change of speed based on physical performance limits</span></div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    <span class="comment">// with a 50% margin to allow the total energy controller to correct for errors.</span></div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    <span class="keywordtype">float</span> velRateMax = 0.5f * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a674913a0d51c181a1010b0fa849de0a3">_STE_rate_max</a> / <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a63dc43165dd4662b98e51f5ac87d15f0">_tas_state</a>;</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    <span class="keywordtype">float</span> velRateMin = 0.5f * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a555f603406804cb69ac4d04a4042ee1f">_STE_rate_min</a> / <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a63dc43165dd4662b98e51f5ac87d15f0">_tas_state</a>;</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a9b530553ef9e6e2b09625bbec5ef8b7c">_TAS_setpoint_adj</a> = <a class="code" href="../../dd/d47/namespacemath.html#a4a49a65edaf29055a3cb021908a031d7">constrain</a>(<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a247b49471892cbe8a414d5981944b639">_TAS_setpoint</a>, <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a18296ff6e8c3066645c4ad2f4b1fdc48">_TAS_min</a>, <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a0d597bd2728311e9804ea8b1ef1f5efa">_TAS_max</a>);</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    <span class="comment">// calculate the demanded rate of change of speed proportional to speed error</span></div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    <span class="comment">// and apply performance limits</span></div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a8a585f4e93479d4ab930a63bea3229a8">_TAS_rate_setpoint</a> = <a class="code" href="../../dd/d47/namespacemath.html#a4a49a65edaf29055a3cb021908a031d7">constrain</a>((<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a9b530553ef9e6e2b09625bbec5ef8b7c">_TAS_setpoint_adj</a> - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a63dc43165dd4662b98e51f5ac87d15f0">_tas_state</a>) * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a16e8ffefa1c5098d11fb7b4a3a11278c">_speed_error_gain</a>, velRateMin, velRateMax);</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;}</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;</div><div class="line"><a name="l00222"></a><span class="lineno"><a class="line" href="../../d1/d1f/class_t_e_c_s.html#a52d4b31866f3a53e2d1fb2c08324a8c0">  222</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a52d4b31866f3a53e2d1fb2c08324a8c0">TECS::_update_height_setpoint</a>(<span class="keywordtype">float</span> desired, <span class="keywordtype">float</span> <a class="code" href="../../d3/dc0/_arm_authorization_8cpp.html#af06c723c3b5220b3ef9839275a0cf051">state</a>)</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;{</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <span class="comment">// Detect first time through and initialize previous value to demand</span></div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d2/d53/ecl_8h.html#a5181155e284a192217ea7e0ea70bb810">ISFINITE</a>(desired) &amp;&amp; fabsf(<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a62a53dfcd8944ef8874db7ab9c7865dc">_hgt_setpoint_in_prev</a>) &lt; 0.1<a class="code" href="../../d8/da1/integration_8cpp.html#af5ba872dd09316732300733cc164ac1a">f</a>) {</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a62a53dfcd8944ef8874db7ab9c7865dc">_hgt_setpoint_in_prev</a> = desired;</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    }</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="comment">// Apply a 2 point moving average to demanded height to reduce</span></div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    <span class="comment">// intersampling noise effects.</span></div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d2/d53/ecl_8h.html#a5181155e284a192217ea7e0ea70bb810">ISFINITE</a>(desired)) {</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#af745ff4a477a38403bb578d9b5577f55">_hgt_setpoint</a> = 0.5f * (desired + <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a62a53dfcd8944ef8874db7ab9c7865dc">_hgt_setpoint_in_prev</a>);</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#af745ff4a477a38403bb578d9b5577f55">_hgt_setpoint</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a62a53dfcd8944ef8874db7ab9c7865dc">_hgt_setpoint_in_prev</a>;</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    }</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a62a53dfcd8944ef8874db7ab9c7865dc">_hgt_setpoint_in_prev</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#af745ff4a477a38403bb578d9b5577f55">_hgt_setpoint</a>;</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    <span class="comment">// Apply a rate limit to respect vehicle performance limitations</span></div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d1f/class_t_e_c_s.html#af745ff4a477a38403bb578d9b5577f55">_hgt_setpoint</a> - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a54a4fe1ece68608c176add392ab68184">_hgt_setpoint_prev</a>) &gt; (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a0314f10a024ad65980a32092108ac4b2">_max_climb_rate</a> * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a3ab0de013572380094a825d89e31365e">_dt</a>)) {</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#af745ff4a477a38403bb578d9b5577f55">_hgt_setpoint</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a54a4fe1ece68608c176add392ab68184">_hgt_setpoint_prev</a> + <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a0314f10a024ad65980a32092108ac4b2">_max_climb_rate</a> * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a3ab0de013572380094a825d89e31365e">_dt</a>;</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d1f/class_t_e_c_s.html#af745ff4a477a38403bb578d9b5577f55">_hgt_setpoint</a> - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a54a4fe1ece68608c176add392ab68184">_hgt_setpoint_prev</a>) &lt; (-<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a5578ae0b9aaf061d02acd77a1b64f43b">_max_sink_rate</a> * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a3ab0de013572380094a825d89e31365e">_dt</a>)) {</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#af745ff4a477a38403bb578d9b5577f55">_hgt_setpoint</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a54a4fe1ece68608c176add392ab68184">_hgt_setpoint_prev</a> - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a5578ae0b9aaf061d02acd77a1b64f43b">_max_sink_rate</a> * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a3ab0de013572380094a825d89e31365e">_dt</a>;</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    }</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a54a4fe1ece68608c176add392ab68184">_hgt_setpoint_prev</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#af745ff4a477a38403bb578d9b5577f55">_hgt_setpoint</a>;</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    <span class="comment">// Apply a first order noise filter</span></div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a38c44464c8e2bf1094fd1e78d2ce33cb">_hgt_setpoint_adj</a> = 0.1f * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#af745ff4a477a38403bb578d9b5577f55">_hgt_setpoint</a> + 0.9f * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aa3615934413da852b1dfec989eb1840c">_hgt_setpoint_adj_prev</a>;</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    <span class="comment">// Calculate the demanded climb rate proportional to height error plus a feedforward term to provide</span></div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    <span class="comment">// tight tracking during steady climb and descent manoeuvres.</span></div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a10f2b8241be721c9ac1862b1b20e9eda">_hgt_rate_setpoint</a> = (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a38c44464c8e2bf1094fd1e78d2ce33cb">_hgt_setpoint_adj</a> - <a class="code" href="../../d3/dc0/_arm_authorization_8cpp.html#af06c723c3b5220b3ef9839275a0cf051">state</a>) * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a72195fb04456d9ce36e6de757cb02660">_height_error_gain</a> + <a class="code" href="../../d1/d1f/class_t_e_c_s.html#abc8d88ad1ae9837410f75087a2f2379b">_height_setpoint_gain_ff</a> *</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                 (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a38c44464c8e2bf1094fd1e78d2ce33cb">_hgt_setpoint_adj</a> - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aa3615934413da852b1dfec989eb1840c">_hgt_setpoint_adj_prev</a>) / <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a3ab0de013572380094a825d89e31365e">_dt</a>;</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aa3615934413da852b1dfec989eb1840c">_hgt_setpoint_adj_prev</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a38c44464c8e2bf1094fd1e78d2ce33cb">_hgt_setpoint_adj</a>;</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    <span class="comment">// Limit the rate of change of height demand to respect vehicle performance limits</span></div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a10f2b8241be721c9ac1862b1b20e9eda">_hgt_rate_setpoint</a> &gt; <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a0314f10a024ad65980a32092108ac4b2">_max_climb_rate</a>) {</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a10f2b8241be721c9ac1862b1b20e9eda">_hgt_rate_setpoint</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a0314f10a024ad65980a32092108ac4b2">_max_climb_rate</a>;</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a10f2b8241be721c9ac1862b1b20e9eda">_hgt_rate_setpoint</a> &lt; -<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a5578ae0b9aaf061d02acd77a1b64f43b">_max_sink_rate</a>) {</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a10f2b8241be721c9ac1862b1b20e9eda">_hgt_rate_setpoint</a> = -<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a5578ae0b9aaf061d02acd77a1b64f43b">_max_sink_rate</a>;</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    }</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;}</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;</div><div class="line"><a name="l00268"></a><span class="lineno"><a class="line" href="../../d1/d1f/class_t_e_c_s.html#a77bfca668f7e22596ff8c3bf624a4eb7">  268</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a77bfca668f7e22596ff8c3bf624a4eb7">TECS::_detect_underspeed</a>()</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;{</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d1f/class_t_e_c_s.html#ad32b8a2728dc4aff6fe09447f19e5bbc">_detect_underspeed_enabled</a>) {</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ab809ed3eda881d853dc4b2a8b4db3bc1">_underspeed_detected</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    }</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    <span class="keywordflow">if</span> (((<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a63dc43165dd4662b98e51f5ac87d15f0">_tas_state</a> &lt; <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a18296ff6e8c3066645c4ad2f4b1fdc48">_TAS_min</a> * 0.9<a class="code" href="../../d8/da1/integration_8cpp.html#af5ba872dd09316732300733cc164ac1a">f</a>) &amp;&amp; (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#accd03f8685f83d31331cac4c76a37d36">_throttle_setpoint</a> &gt;= <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a41f29be4495546610a800fb13e74368b">_throttle_setpoint_max</a> * 0.95f))</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;        || ((<a class="code" href="../../d1/d1f/class_t_e_c_s.html#ae680021e0c92c9da05429c915b415d7e">_vert_pos_state</a> &lt; <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a38c44464c8e2bf1094fd1e78d2ce33cb">_hgt_setpoint_adj</a>) &amp;&amp; <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ab809ed3eda881d853dc4b2a8b4db3bc1">_underspeed_detected</a>)) {</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ab809ed3eda881d853dc4b2a8b4db3bc1">_underspeed_detected</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ab809ed3eda881d853dc4b2a8b4db3bc1">_underspeed_detected</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;    }</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;}</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;</div><div class="line"><a name="l00285"></a><span class="lineno"><a class="line" href="../../d1/d1f/class_t_e_c_s.html#a9df3e59fc5b1e294c7aa3f3c21c48f1b">  285</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a9df3e59fc5b1e294c7aa3f3c21c48f1b">TECS::_update_energy_estimates</a>()</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;{</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    <span class="comment">// Calculate specific energy demands in units of (m**2/sec**2)</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a70933c91f037cd6accca28805a8155da">_SPE_setpoint</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a38c44464c8e2bf1094fd1e78d2ce33cb">_hgt_setpoint_adj</a> * <a class="code" href="../../db/d35/geo_8h.html#a32a64125a796fad5c13297499d50b082">CONSTANTS_ONE_G</a>; <span class="comment">// potential energy</span></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a9897752b5b90aa5abb1fcf46b90f5889">_SKE_setpoint</a> = 0.5f * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a9b530553ef9e6e2b09625bbec5ef8b7c">_TAS_setpoint_adj</a> * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a9b530553ef9e6e2b09625bbec5ef8b7c">_TAS_setpoint_adj</a>; <span class="comment">// kinetic energy</span></div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;    <span class="comment">// Calculate specific energy rate demands in units of (m**2/sec**3)</span></div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ac1170fb4bae85e2229562758ce932500">_SPE_rate_setpoint</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a10f2b8241be721c9ac1862b1b20e9eda">_hgt_rate_setpoint</a> * <a class="code" href="../../db/d35/geo_8h.html#a32a64125a796fad5c13297499d50b082">CONSTANTS_ONE_G</a>; <span class="comment">// potential energy rate of change</span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a78bbe16f2037a98a7080891f68114db2">_SKE_rate_setpoint</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a63dc43165dd4662b98e51f5ac87d15f0">_tas_state</a> * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a8a585f4e93479d4ab930a63bea3229a8">_TAS_rate_setpoint</a>; <span class="comment">// kinetic energy rate of change</span></div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;    <span class="comment">// Calculate specific energies in units of (m**2/sec**2)</span></div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ad55696d5bee9f3ac4bc80a0f85a885bc">_SPE_estimate</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ae680021e0c92c9da05429c915b415d7e">_vert_pos_state</a> * <a class="code" href="../../db/d35/geo_8h.html#a32a64125a796fad5c13297499d50b082">CONSTANTS_ONE_G</a>; <span class="comment">// potential energy</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aaa1bdb9455890bb186ffb899875fc74b">_SKE_estimate</a> = 0.5f * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a63dc43165dd4662b98e51f5ac87d15f0">_tas_state</a> * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a63dc43165dd4662b98e51f5ac87d15f0">_tas_state</a>; <span class="comment">// kinetic energy</span></div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    <span class="comment">// Calculate specific energy rates in units of (m**2/sec**3)</span></div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a778f00ba2f171ea1783bbb9795a264c5">_SPE_rate</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a7a4184c3a5c301b95e93b3ca9bf26dd7">_vert_vel_state</a> * <a class="code" href="../../db/d35/geo_8h.html#a32a64125a796fad5c13297499d50b082">CONSTANTS_ONE_G</a>; <span class="comment">// potential energy rate of change</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a8e12e8101f533b0f000f142ad509a545">_SKE_rate</a> = _tas_state * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a2cd6cd2c99aac892c8cc41a0392dba92">_speed_derivative</a>;<span class="comment">// kinetic energy rate of change</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;}</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;</div><div class="line"><a name="l00304"></a><span class="lineno"><a class="line" href="../../d1/d1f/class_t_e_c_s.html#aa46d349335c601e995746ea03306526b">  304</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aa46d349335c601e995746ea03306526b">TECS::_update_throttle_setpoint</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> throttle_cruise, <span class="keyword">const</span> <a class="code" href="../../d4/d11/classmatrix_1_1_dcm.html">matrix::Dcmf</a> &amp;rotMat)</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;{</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    <span class="comment">// Calculate total energy error</span></div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a054d1b84c6719847ae15e908ca616642">_STE_error</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a70933c91f037cd6accca28805a8155da">_SPE_setpoint</a> - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ad55696d5bee9f3ac4bc80a0f85a885bc">_SPE_estimate</a> + <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a9897752b5b90aa5abb1fcf46b90f5889">_SKE_setpoint</a> - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aaa1bdb9455890bb186ffb899875fc74b">_SKE_estimate</a>;</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    <span class="comment">// Calculate demanded rate of change of total energy, respecting vehicle limits</span></div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    <span class="keywordtype">float</span> STE_rate_setpoint = <a class="code" href="../../dd/d47/namespacemath.html#a4a49a65edaf29055a3cb021908a031d7">constrain</a>((<a class="code" href="../../d1/d1f/class_t_e_c_s.html#ac1170fb4bae85e2229562758ce932500">_SPE_rate_setpoint</a> + <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a78bbe16f2037a98a7080891f68114db2">_SKE_rate_setpoint</a>), <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a555f603406804cb69ac4d04a4042ee1f">_STE_rate_min</a>, <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a674913a0d51c181a1010b0fa849de0a3">_STE_rate_max</a>);</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    <span class="comment">// Calculate the total energy rate error, applying a first order IIR filter</span></div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    <span class="comment">// to reduce the effect of accelerometer noise</span></div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a51126f8571149af17e701829e6fc31d3">_STE_rate_error</a> = 0.2f * (STE_rate_setpoint - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a778f00ba2f171ea1783bbb9795a264c5">_SPE_rate</a> - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a8e12e8101f533b0f000f142ad509a545">_SKE_rate</a>) + 0.8<a class="code" href="../../d8/da1/integration_8cpp.html#af5ba872dd09316732300733cc164ac1a">f</a> * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a51126f8571149af17e701829e6fc31d3">_STE_rate_error</a>;</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    <span class="comment">// Calculate the throttle demand</span></div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#ab809ed3eda881d853dc4b2a8b4db3bc1">_underspeed_detected</a>) {</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;        <span class="comment">// always use full throttle to recover from an underspeed condition</span></div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#accd03f8685f83d31331cac4c76a37d36">_throttle_setpoint</a> = 1.0f;</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;        <span class="comment">// Adjust the demanded total energy rate to compensate for induced drag rise in turns.</span></div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;        <span class="comment">// Assume induced drag scales linearly with normal load factor.</span></div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;        <span class="comment">// The additional normal load factor is given by (1/cos(bank angle) - 1)</span></div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;        <span class="keywordtype">float</span> cosPhi = sqrtf((rotMat(0, 1) * rotMat(0, 1)) + (rotMat(1, 1) * rotMat(1, 1)));</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        STE_rate_setpoint = STE_rate_setpoint + <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ae627d8fc2349e502b6021326e4959a32">_load_factor_correction</a> * (1.0f / <a class="code" href="../../dd/d47/namespacemath.html#a4a49a65edaf29055a3cb021908a031d7">constrain</a>(cosPhi, 0.1<a class="code" href="../../d8/da1/integration_8cpp.html#af5ba872dd09316732300733cc164ac1a">f</a>, 1.0<a class="code" href="../../d8/da1/integration_8cpp.html#af5ba872dd09316732300733cc164ac1a">f</a>) - 1.0f);</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;        <span class="comment">// Calculate a predicted throttle from the demanded rate of change of energy, using the cruise throttle</span></div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;        <span class="comment">// as the starting point. Assume:</span></div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;        <span class="comment">// Specific total energy rate = _STE_rate_max is achieved when throttle is set to _throttle_setpoint_max</span></div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;        <span class="comment">// Specific total energy rate = 0 at cruise throttle</span></div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;        <span class="comment">// Specific total energy rate = _STE_rate_min is achieved when throttle is set to _throttle_setpoint_min</span></div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;        <span class="keywordtype">float</span> throttle_predicted = 0.0f;</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;        <span class="keywordflow">if</span> (STE_rate_setpoint &gt;= 0) {</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;            <span class="comment">// throttle is between cruise and maximum</span></div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;            throttle_predicted = throttle_cruise + STE_rate_setpoint / <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a674913a0d51c181a1010b0fa849de0a3">_STE_rate_max</a> * (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a41f29be4495546610a800fb13e74368b">_throttle_setpoint_max</a> - throttle_cruise);</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;            <span class="comment">// throttle is between cruise and minimum</span></div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;            throttle_predicted = throttle_cruise + STE_rate_setpoint / <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a555f603406804cb69ac4d04a4042ee1f">_STE_rate_min</a> * (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#afa455a481e8b6cd23febab3ba52b547e">_throttle_setpoint_min</a> - throttle_cruise);</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;        }</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        <span class="comment">// Calculate gain scaler from specific energy error to throttle</span></div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        <span class="keywordtype">float</span> STE_to_throttle = 1.0f / (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#aa58f800b3a774edca8b400a4f70c616f">_throttle_time_constant</a> * (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a674913a0d51c181a1010b0fa849de0a3">_STE_rate_max</a> - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a555f603406804cb69ac4d04a4042ee1f">_STE_rate_min</a>));</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        <span class="comment">// Add proportional and derivative control feedback to the predicted throttle and constrain to throttle limits</span></div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#accd03f8685f83d31331cac4c76a37d36">_throttle_setpoint</a> = (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a054d1b84c6719847ae15e908ca616642">_STE_error</a> + <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a51126f8571149af17e701829e6fc31d3">_STE_rate_error</a> * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a500bb4f60008185cf2554b503109670a">_throttle_damping_gain</a>) * STE_to_throttle + throttle_predicted;</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#accd03f8685f83d31331cac4c76a37d36">_throttle_setpoint</a> = <a class="code" href="../../dd/d47/namespacemath.html#a4a49a65edaf29055a3cb021908a031d7">constrain</a>(<a class="code" href="../../d1/d1f/class_t_e_c_s.html#accd03f8685f83d31331cac4c76a37d36">_throttle_setpoint</a>, <a class="code" href="../../d1/d1f/class_t_e_c_s.html#afa455a481e8b6cd23febab3ba52b547e">_throttle_setpoint_min</a>, <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a41f29be4495546610a800fb13e74368b">_throttle_setpoint_max</a>);</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;        <span class="comment">// Rate limit the throttle demand</span></div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;        <span class="keywordflow">if</span> (fabsf(<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a9540da1f79d7eb6001bb843a6d9e1e0d">_throttle_slewrate</a>) &gt; 0.01<a class="code" href="../../d8/da1/integration_8cpp.html#af5ba872dd09316732300733cc164ac1a">f</a>) {</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;            <span class="keywordtype">float</span> throttle_increment_limit = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a3ab0de013572380094a825d89e31365e">_dt</a> * (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a41f29be4495546610a800fb13e74368b">_throttle_setpoint_max</a> - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#afa455a481e8b6cd23febab3ba52b547e">_throttle_setpoint_min</a>) * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a9540da1f79d7eb6001bb843a6d9e1e0d">_throttle_slewrate</a>;</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;            <a class="code" href="../../d1/d1f/class_t_e_c_s.html#accd03f8685f83d31331cac4c76a37d36">_throttle_setpoint</a> = <a class="code" href="../../dd/d47/namespacemath.html#a4a49a65edaf29055a3cb021908a031d7">constrain</a>(_throttle_setpoint, <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a370014b30b390f27086b89f8fba2c746">_last_throttle_setpoint</a> - throttle_increment_limit,</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;                               <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a370014b30b390f27086b89f8fba2c746">_last_throttle_setpoint</a> + throttle_increment_limit);</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;        }</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a370014b30b390f27086b89f8fba2c746">_last_throttle_setpoint</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#accd03f8685f83d31331cac4c76a37d36">_throttle_setpoint</a>;</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#af47096e3328a512b1c573aa1afc5f031">_integrator_gain</a> &gt; 0.0<a class="code" href="../../d8/da1/integration_8cpp.html#af5ba872dd09316732300733cc164ac1a">f</a>) {</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;            <span class="comment">// Calculate throttle integrator state upper and lower limits with allowance for</span></div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;            <span class="comment">// 10% throttle saturation to accommodate noise on the demand.</span></div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;            <span class="keywordtype">float</span> integ_state_max = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a41f29be4495546610a800fb13e74368b">_throttle_setpoint_max</a> - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#accd03f8685f83d31331cac4c76a37d36">_throttle_setpoint</a> + 0.1f;</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;            <span class="keywordtype">float</span> integ_state_min = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#afa455a481e8b6cd23febab3ba52b547e">_throttle_setpoint_min</a> - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#accd03f8685f83d31331cac4c76a37d36">_throttle_setpoint</a> - 0.1f;</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;            <span class="comment">// Calculate a throttle demand from the integrated total energy error</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;            <span class="comment">// This will be added to the total throttle demand to compensate for steady state errors</span></div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;            <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ae405982aa408beacb0a07f4455b27992">_throttle_integ_state</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ae405982aa408beacb0a07f4455b27992">_throttle_integ_state</a> + (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a054d1b84c6719847ae15e908ca616642">_STE_error</a> * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#af47096e3328a512b1c573aa1afc5f031">_integrator_gain</a>) * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a3ab0de013572380094a825d89e31365e">_dt</a> * STE_to_throttle;</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a3779fae0c2dc512fd4640b5f78b8b935">_climbout_mode_active</a>) {</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;                <span class="comment">// During climbout, set the integrator to maximum throttle to prevent transient throttle drop</span></div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;                <span class="comment">// at end of climbout when we transition to closed loop throttle control</span></div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;                <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ae405982aa408beacb0a07f4455b27992">_throttle_integ_state</a> = integ_state_max;</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;                <span class="comment">// Respect integrator limits during closed loop operation.</span></div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;                <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ae405982aa408beacb0a07f4455b27992">_throttle_integ_state</a> = <a class="code" href="../../dd/d47/namespacemath.html#a4a49a65edaf29055a3cb021908a031d7">constrain</a>(<a class="code" href="../../d1/d1f/class_t_e_c_s.html#ae405982aa408beacb0a07f4455b27992">_throttle_integ_state</a>, integ_state_min, integ_state_max);</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;            }</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;            <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ae405982aa408beacb0a07f4455b27992">_throttle_integ_state</a> = 0.0f;</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;        }</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#aecdf93951f7e0e7d056383826debfcf6">airspeed_sensor_enabled</a>()) {</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;            <span class="comment">// Add the integrator feedback during closed loop operation with an airspeed sensor</span></div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;            <a class="code" href="../../d1/d1f/class_t_e_c_s.html#accd03f8685f83d31331cac4c76a37d36">_throttle_setpoint</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#accd03f8685f83d31331cac4c76a37d36">_throttle_setpoint</a> + <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ae405982aa408beacb0a07f4455b27992">_throttle_integ_state</a>;</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;            <span class="comment">// when flying without an airspeed sensor, use the predicted throttle only</span></div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;            <a class="code" href="../../d1/d1f/class_t_e_c_s.html#accd03f8685f83d31331cac4c76a37d36">_throttle_setpoint</a> = throttle_predicted;</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;        }</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#accd03f8685f83d31331cac4c76a37d36">_throttle_setpoint</a> = <a class="code" href="../../dd/d47/namespacemath.html#a4a49a65edaf29055a3cb021908a031d7">constrain</a>(<a class="code" href="../../d1/d1f/class_t_e_c_s.html#accd03f8685f83d31331cac4c76a37d36">_throttle_setpoint</a>, <a class="code" href="../../d1/d1f/class_t_e_c_s.html#afa455a481e8b6cd23febab3ba52b547e">_throttle_setpoint_min</a>, <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a41f29be4495546610a800fb13e74368b">_throttle_setpoint_max</a>);</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;    }</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;}</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;</div><div class="line"><a name="l00399"></a><span class="lineno"><a class="line" href="../../d1/d1f/class_t_e_c_s.html#a744cffdf8757b70e4051f05afa078922">  399</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a744cffdf8757b70e4051f05afa078922">TECS::_detect_uncommanded_descent</a>()</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;{</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="comment">     * This function detects a condition that can occur when the demanded airspeed is greater than the</span></div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;<span class="comment">     * aircraft can achieve in level flight. When this occurs, the vehicle will continue to reduce height</span></div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="comment">     * while attempting to maintain speed.</span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;<span class="comment">    */</span></div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    <span class="comment">// Calculate rate of change of total specific energy</span></div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    <span class="keywordtype">float</span> STE_rate = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a778f00ba2f171ea1783bbb9795a264c5">_SPE_rate</a> + <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a8e12e8101f533b0f000f142ad509a545">_SKE_rate</a>;</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    <span class="comment">// If total energy is very low and reducing, throttle is high, and we are not in an underspeed condition, then enter uncommanded descent recovery mode</span></div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    <span class="keywordtype">bool</span> enter_mode = !<a class="code" href="../../d1/d1f/class_t_e_c_s.html#aca64b0d6f48ae591bf07a138a90ddfa3">_uncommanded_descent_recovery</a> &amp;&amp; !<a class="code" href="../../d1/d1f/class_t_e_c_s.html#ab809ed3eda881d853dc4b2a8b4db3bc1">_underspeed_detected</a> &amp;&amp; (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a054d1b84c6719847ae15e908ca616642">_STE_error</a> &gt; 200.0f) &amp;&amp; (STE_rate &lt; 0.0<a class="code" href="../../d8/da1/integration_8cpp.html#af5ba872dd09316732300733cc164ac1a">f</a>)</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;              &amp;&amp; (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#accd03f8685f83d31331cac4c76a37d36">_throttle_setpoint</a> &gt;= <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a41f29be4495546610a800fb13e74368b">_throttle_setpoint_max</a> * 0.9f);</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;    <span class="comment">// If we enter an underspeed condition or recover the required total energy, then exit uncommanded descent recovery mode</span></div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;    <span class="keywordtype">bool</span> exit_mode = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aca64b0d6f48ae591bf07a138a90ddfa3">_uncommanded_descent_recovery</a> &amp;&amp; (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#ab809ed3eda881d853dc4b2a8b4db3bc1">_underspeed_detected</a> || (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a054d1b84c6719847ae15e908ca616642">_STE_error</a> &lt; 0.0f));</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;    <span class="keywordflow">if</span> (enter_mode) {</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aca64b0d6f48ae591bf07a138a90ddfa3">_uncommanded_descent_recovery</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (exit_mode) {</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aca64b0d6f48ae591bf07a138a90ddfa3">_uncommanded_descent_recovery</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    }</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;}</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;</div><div class="line"><a name="l00426"></a><span class="lineno"><a class="line" href="../../d1/d1f/class_t_e_c_s.html#a1f75a0a5bda6c6708b8f02b01ec68da5">  426</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a1f75a0a5bda6c6708b8f02b01ec68da5">TECS::_update_pitch_setpoint</a>()</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;{</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    <span class="comment">/*</span></div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;<span class="comment">     * The SKE_weighting variable controls how speed and height control are prioritised by the pitch demand calculation.</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;<span class="comment">     * A weighting of 1 givea equal speed and height priority</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;<span class="comment">     * A weighting of 0 gives 100% priority to height control and must be used when no airspeed measurement is available.</span></div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;<span class="comment">     * A weighting of 2 provides 100% priority to speed control and is used when:</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;<span class="comment">     * a) an underspeed condition is detected.</span></div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;<span class="comment">     * b) during climbout where a minimum pitch angle has been set to ensure height is gained. If the airspeed</span></div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;<span class="comment">     * rises above the demanded value, the pitch angle demand is increased by the TECS controller to prevent the vehicle overspeeding.</span></div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;<span class="comment">     * The weighting can be adjusted between 0 and 2 depending on speed and height accuracy requirements.</span></div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;<span class="comment">    */</span></div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;    <span class="comment">// Calculate the weighting applied to control of specific kinetic energy error</span></div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;    <span class="keywordtype">float</span> SKE_weighting = <a class="code" href="../../dd/d47/namespacemath.html#a4a49a65edaf29055a3cb021908a031d7">constrain</a>(<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a93742f830629d1a8ef06ee9d374a1233">_pitch_speed_weight</a>, 0.0<a class="code" href="../../d8/da1/integration_8cpp.html#af5ba872dd09316732300733cc164ac1a">f</a>, 2.0<a class="code" href="../../d8/da1/integration_8cpp.html#af5ba872dd09316732300733cc164ac1a">f</a>);</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;    <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d1f/class_t_e_c_s.html#ab809ed3eda881d853dc4b2a8b4db3bc1">_underspeed_detected</a> || <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a3779fae0c2dc512fd4640b5f78b8b935">_climbout_mode_active</a>) &amp;&amp; <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aecdf93951f7e0e7d056383826debfcf6">airspeed_sensor_enabled</a>()) {</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;        SKE_weighting = 2.0f;</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d1f/class_t_e_c_s.html#aecdf93951f7e0e7d056383826debfcf6">airspeed_sensor_enabled</a>()) {</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;        SKE_weighting = 0.0f;</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;    }</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;    <span class="comment">// Calculate the weighting applied to control of specific potential energy error</span></div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;    <span class="keywordtype">float</span> SPE_weighting = 2.0f - SKE_weighting;</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;    <span class="comment">// Calculate the specific energy balance demand which specifies how the available total</span></div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;    <span class="comment">// energy should be allocated to speed (kinetic energy) and height (potential energy)</span></div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;    <span class="keywordtype">float</span> SEB_setpoint = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a70933c91f037cd6accca28805a8155da">_SPE_setpoint</a> * SPE_weighting - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a9897752b5b90aa5abb1fcf46b90f5889">_SKE_setpoint</a> * SKE_weighting;</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;    <span class="comment">// Calculate the specific energy balance rate demand</span></div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;    <span class="keywordtype">float</span> SEB_rate_setpoint = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ac1170fb4bae85e2229562758ce932500">_SPE_rate_setpoint</a> * SPE_weighting - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a78bbe16f2037a98a7080891f68114db2">_SKE_rate_setpoint</a> * SKE_weighting;</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;    <span class="comment">// Calculate the specific energy balance and balance rate error</span></div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a746eb83d156c47eecb28e0fb6b2fc1e5">_SEB_error</a> = SEB_setpoint - (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#ad55696d5bee9f3ac4bc80a0f85a885bc">_SPE_estimate</a> * SPE_weighting - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aaa1bdb9455890bb186ffb899875fc74b">_SKE_estimate</a> * SKE_weighting);</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a5a1c7de2bee26a58eff5e6044a1fc50d">_SEB_rate_error</a> = SEB_rate_setpoint - (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a778f00ba2f171ea1783bbb9795a264c5">_SPE_rate</a> * SPE_weighting - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a8e12e8101f533b0f000f142ad509a545">_SKE_rate</a> * SKE_weighting);</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;    <span class="comment">// Calculate derivative from change in climb angle to rate of change of specific energy balance</span></div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;    <span class="keywordtype">float</span> climb_angle_to_SEB_rate = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a63dc43165dd4662b98e51f5ac87d15f0">_tas_state</a> * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a35a4dc41fd04a11df4f449a9d6210544">_pitch_time_constant</a> * <a class="code" href="../../db/d35/geo_8h.html#a32a64125a796fad5c13297499d50b082">CONSTANTS_ONE_G</a>;</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#af47096e3328a512b1c573aa1afc5f031">_integrator_gain</a> &gt; 0.0<a class="code" href="../../d8/da1/integration_8cpp.html#af5ba872dd09316732300733cc164ac1a">f</a>) {</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;        <span class="comment">// Calculate pitch integrator input term</span></div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;        <span class="keywordtype">float</span> pitch_integ_input = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a746eb83d156c47eecb28e0fb6b2fc1e5">_SEB_error</a> * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#af47096e3328a512b1c573aa1afc5f031">_integrator_gain</a>;</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;        <span class="comment">// Prevent the integrator changing in a direction that will increase pitch demand saturation</span></div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;        <span class="comment">// Decay the integrator at the control loop time constant if the pitch demand from the previous time step is saturated</span></div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a591ee0a89db163f0dadda75ac35184ee">_pitch_setpoint_unc</a> &gt; <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a11358a70d4e805a267126195a7f1f277">_pitch_setpoint_max</a>) {</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;            pitch_integ_input = <a class="code" href="../../dd/d47/namespacemath.html#a0590ec5bbbdad228b5a47307af425055">min</a>(pitch_integ_input,</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;                        <a class="code" href="../../dd/d47/namespacemath.html#a0590ec5bbbdad228b5a47307af425055">min</a>((<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a11358a70d4e805a267126195a7f1f277">_pitch_setpoint_max</a> - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a591ee0a89db163f0dadda75ac35184ee">_pitch_setpoint_unc</a>) * climb_angle_to_SEB_rate / <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a35a4dc41fd04a11df4f449a9d6210544">_pitch_time_constant</a>, 0.0<a class="code" href="../../d8/da1/integration_8cpp.html#af5ba872dd09316732300733cc164ac1a">f</a>));</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a591ee0a89db163f0dadda75ac35184ee">_pitch_setpoint_unc</a> &lt; <a class="code" href="../../d1/d1f/class_t_e_c_s.html#af92cd0c66cd8a6cf5f57b608c90347c4">_pitch_setpoint_min</a>) {</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;            pitch_integ_input = <a class="code" href="../../dd/d47/namespacemath.html#ad42187b143e9e0e96bb14c7edcfbfef6">max</a>(pitch_integ_input,</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;                        <a class="code" href="../../dd/d47/namespacemath.html#ad42187b143e9e0e96bb14c7edcfbfef6">max</a>((<a class="code" href="../../d1/d1f/class_t_e_c_s.html#af92cd0c66cd8a6cf5f57b608c90347c4">_pitch_setpoint_min</a> - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a591ee0a89db163f0dadda75ac35184ee">_pitch_setpoint_unc</a>) * climb_angle_to_SEB_rate / <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a35a4dc41fd04a11df4f449a9d6210544">_pitch_time_constant</a>, 0.0<a class="code" href="../../d8/da1/integration_8cpp.html#af5ba872dd09316732300733cc164ac1a">f</a>));</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;        }</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;        <span class="comment">// Update the pitch integrator state.</span></div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a2dabe0c9724c35d4f5f14b690902edae">_pitch_integ_state</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a2dabe0c9724c35d4f5f14b690902edae">_pitch_integ_state</a> + pitch_integ_input * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a3ab0de013572380094a825d89e31365e">_dt</a>;</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a2dabe0c9724c35d4f5f14b690902edae">_pitch_integ_state</a> = 0.0f;</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;    }</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;    <span class="comment">// Calculate a specific energy correction that doesn&#39;t include the integrator contribution</span></div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;    <span class="keywordtype">float</span> SEB_correction = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a746eb83d156c47eecb28e0fb6b2fc1e5">_SEB_error</a> + _SEB_rate_error * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a81e71ebe1d88cb2889cc880adcc61b19">_pitch_damping_gain</a> + SEB_rate_setpoint * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a35a4dc41fd04a11df4f449a9d6210544">_pitch_time_constant</a>;</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    <span class="comment">// During climbout, bias the demanded pitch angle so that a zero speed error produces a pitch angle</span></div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;    <span class="comment">// demand equal to the minimum pitch angle set by the mission plan. This prevents the integrator</span></div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;    <span class="comment">// having to catch up before the nose can be raised to reduce excess speed during climbout.</span></div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a3779fae0c2dc512fd4640b5f78b8b935">_climbout_mode_active</a>) {</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;        SEB_correction += <a class="code" href="../../d1/d1f/class_t_e_c_s.html#af92cd0c66cd8a6cf5f57b608c90347c4">_pitch_setpoint_min</a> * climb_angle_to_SEB_rate;</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    }</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    <span class="comment">// Sum the correction terms and convert to a pitch angle demand. This calculation assumes:</span></div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <span class="comment">// a) The climb angle follows pitch angle with a lag that is small enough not to destabilise the control loop.</span></div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    <span class="comment">// b) The offset between climb angle and pitch angle (angle of attack) is constant, excluding the effect of</span></div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;    <span class="comment">// pitch transients due to control action or turbulence.</span></div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a591ee0a89db163f0dadda75ac35184ee">_pitch_setpoint_unc</a> = (SEB_correction + <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a2dabe0c9724c35d4f5f14b690902edae">_pitch_integ_state</a>) / climb_angle_to_SEB_rate;</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#acbc17a214656270c156f8c5ce731c611">_pitch_setpoint</a> = <a class="code" href="../../dd/d47/namespacemath.html#a4a49a65edaf29055a3cb021908a031d7">constrain</a>(<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a591ee0a89db163f0dadda75ac35184ee">_pitch_setpoint_unc</a>, <a class="code" href="../../d1/d1f/class_t_e_c_s.html#af92cd0c66cd8a6cf5f57b608c90347c4">_pitch_setpoint_min</a>, <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a11358a70d4e805a267126195a7f1f277">_pitch_setpoint_max</a>);</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;    <span class="comment">// Comply with the specified vertical acceleration limit by applying a pitch rate limit</span></div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;    <span class="keywordtype">float</span> ptchRateIncr = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a3ab0de013572380094a825d89e31365e">_dt</a> * <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a3f2d95c1eb8f4cee7bd7f2b61c908953">_vert_accel_limit</a> / <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a63dc43165dd4662b98e51f5ac87d15f0">_tas_state</a>;</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;    <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d1f/class_t_e_c_s.html#acbc17a214656270c156f8c5ce731c611">_pitch_setpoint</a> - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a94813442c376e5a4f472cdecf45f89b6">_last_pitch_setpoint</a>) &gt; ptchRateIncr) {</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#acbc17a214656270c156f8c5ce731c611">_pitch_setpoint</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a94813442c376e5a4f472cdecf45f89b6">_last_pitch_setpoint</a> + ptchRateIncr;</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d1f/class_t_e_c_s.html#acbc17a214656270c156f8c5ce731c611">_pitch_setpoint</a> - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a94813442c376e5a4f472cdecf45f89b6">_last_pitch_setpoint</a>) &lt; -ptchRateIncr) {</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#acbc17a214656270c156f8c5ce731c611">_pitch_setpoint</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a94813442c376e5a4f472cdecf45f89b6">_last_pitch_setpoint</a> - ptchRateIncr;</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;    }</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a94813442c376e5a4f472cdecf45f89b6">_last_pitch_setpoint</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#acbc17a214656270c156f8c5ce731c611">_pitch_setpoint</a>;</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;}</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;</div><div class="line"><a name="l00518"></a><span class="lineno"><a class="line" href="../../d1/d1f/class_t_e_c_s.html#a3c9071e0e57efc5e8570212f629bab17">  518</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a3c9071e0e57efc5e8570212f629bab17">TECS::_initialize_states</a>(<span class="keywordtype">float</span> pitch, <span class="keywordtype">float</span> throttle_cruise, <span class="keywordtype">float</span> baro_altitude, <span class="keywordtype">float</span> pitch_min_climbout,</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;                  <span class="keywordtype">float</span> EAS2TAS)</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;{</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a491d4df45e601faaf15d149f00ba5d4b">_pitch_update_timestamp</a> == 0 || <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a3ab0de013572380094a825d89e31365e">_dt</a> &gt; <a class="code" href="../../db/da1/tecs_8cpp.html#a85417aeee491c2add265c8041e690ec0">DT_MAX</a> || !<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a4323d25b277e12fd373be58e3110cdab">_in_air</a> || !<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a06802c5fc4a2aee207156706117d889d">_states_initalized</a>) {</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;        <span class="comment">// On first time through or when not using TECS of if there has been a large time slip,</span></div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;        <span class="comment">// states must be reset to allow filters to a clean start</span></div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ac9dffa45ad1bfadc69e5e3b75e2de25d">_vert_accel_state</a> = 0.0f;</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a7a4184c3a5c301b95e93b3ca9bf26dd7">_vert_vel_state</a> = 0.0f;</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ae680021e0c92c9da05429c915b415d7e">_vert_pos_state</a> = baro_altitude;</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ab8e692959353fac04c1e2b4b62f06425">_tas_rate_state</a> = 0.0f;</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a63dc43165dd4662b98e51f5ac87d15f0">_tas_state</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ad3a8467e9cf0fd678c9cd4489c37419c">_EAS</a> * EAS2TAS;</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ae405982aa408beacb0a07f4455b27992">_throttle_integ_state</a> =  0.0f;</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a2dabe0c9724c35d4f5f14b690902edae">_pitch_integ_state</a> = 0.0f;</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a370014b30b390f27086b89f8fba2c746">_last_throttle_setpoint</a> = (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a4323d25b277e12fd373be58e3110cdab">_in_air</a> ? throttle_cruise : 0.0f);;</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a94813442c376e5a4f472cdecf45f89b6">_last_pitch_setpoint</a> = <a class="code" href="../../dd/d47/namespacemath.html#a4a49a65edaf29055a3cb021908a031d7">constrain</a>(pitch, <a class="code" href="../../d1/d1f/class_t_e_c_s.html#af92cd0c66cd8a6cf5f57b608c90347c4">_pitch_setpoint_min</a>, <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a11358a70d4e805a267126195a7f1f277">_pitch_setpoint_max</a>);</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a591ee0a89db163f0dadda75ac35184ee">_pitch_setpoint_unc</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a94813442c376e5a4f472cdecf45f89b6">_last_pitch_setpoint</a>;</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aa3615934413da852b1dfec989eb1840c">_hgt_setpoint_adj_prev</a> = baro_altitude;</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a38c44464c8e2bf1094fd1e78d2ce33cb">_hgt_setpoint_adj</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aa3615934413da852b1dfec989eb1840c">_hgt_setpoint_adj_prev</a>;</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a54a4fe1ece68608c176add392ab68184">_hgt_setpoint_prev</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aa3615934413da852b1dfec989eb1840c">_hgt_setpoint_adj_prev</a>;</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a62a53dfcd8944ef8874db7ab9c7865dc">_hgt_setpoint_in_prev</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aa3615934413da852b1dfec989eb1840c">_hgt_setpoint_adj_prev</a>;</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a5c948a3760ef7842f6cceeb1e2fa37e1">_TAS_setpoint_last</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ad3a8467e9cf0fd678c9cd4489c37419c">_EAS</a> * EAS2TAS;</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a9b530553ef9e6e2b09625bbec5ef8b7c">_TAS_setpoint_adj</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a5c948a3760ef7842f6cceeb1e2fa37e1">_TAS_setpoint_last</a>;</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ab809ed3eda881d853dc4b2a8b4db3bc1">_underspeed_detected</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aca64b0d6f48ae591bf07a138a90ddfa3">_uncommanded_descent_recovery</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a51126f8571149af17e701829e6fc31d3">_STE_rate_error</a> = 0.0f;</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a3ab0de013572380094a825d89e31365e">_dt</a> &gt; <a class="code" href="../../db/da1/tecs_8cpp.html#a85417aeee491c2add265c8041e690ec0">DT_MAX</a> || <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a3ab0de013572380094a825d89e31365e">_dt</a> &lt; <a class="code" href="../../db/da1/tecs_8cpp.html#a31dce443d7ddc17762497a06a865d8b6">DT_MIN</a>) {</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;            <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a3ab0de013572380094a825d89e31365e">_dt</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a9d91854786fdf8697c224df982f4ba5c">DT_DEFAULT</a>;</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;        }</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a3779fae0c2dc512fd4640b5f78b8b935">_climbout_mode_active</a>) {</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;        <span class="comment">// During climbout use the lower pitch angle limit specified by the</span></div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;        <span class="comment">// calling controller</span></div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#af92cd0c66cd8a6cf5f57b608c90347c4">_pitch_setpoint_min</a>    = pitch_min_climbout;</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;        <span class="comment">// throttle lower limit is set to a value that prevents throttle reduction</span></div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#afa455a481e8b6cd23febab3ba52b547e">_throttle_setpoint_min</a>  = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a41f29be4495546610a800fb13e74368b">_throttle_setpoint_max</a> - 0.01f;</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;        <span class="comment">// height demand and associated states are set to track the measured height</span></div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aa3615934413da852b1dfec989eb1840c">_hgt_setpoint_adj_prev</a>  = baro_altitude;</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a38c44464c8e2bf1094fd1e78d2ce33cb">_hgt_setpoint_adj</a>       = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aa3615934413da852b1dfec989eb1840c">_hgt_setpoint_adj_prev</a>;</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a54a4fe1ece68608c176add392ab68184">_hgt_setpoint_prev</a>      = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aa3615934413da852b1dfec989eb1840c">_hgt_setpoint_adj_prev</a>;</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;        <span class="comment">// airspeed demand states are set to track the measured airspeed</span></div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a5c948a3760ef7842f6cceeb1e2fa37e1">_TAS_setpoint_last</a>      = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ad3a8467e9cf0fd678c9cd4489c37419c">_EAS</a> * EAS2TAS;</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a9b530553ef9e6e2b09625bbec5ef8b7c">_TAS_setpoint_adj</a>       = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ad3a8467e9cf0fd678c9cd4489c37419c">_EAS</a> * EAS2TAS;</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;        <span class="comment">// disable speed and decent error condition checks</span></div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ab809ed3eda881d853dc4b2a8b4db3bc1">_underspeed_detected</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;        <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aca64b0d6f48ae591bf07a138a90ddfa3">_uncommanded_descent_recovery</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    }</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a06802c5fc4a2aee207156706117d889d">_states_initalized</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;}</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;</div><div class="line"><a name="l00573"></a><span class="lineno"><a class="line" href="../../d1/d1f/class_t_e_c_s.html#a4732c2d116797890c55e3c6d11663b2d">  573</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a4732c2d116797890c55e3c6d11663b2d">TECS::_update_STE_rate_lim</a>()</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;{</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;    <span class="comment">// Calculate the specific total energy upper rate limits from the max throttle climb rate</span></div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a674913a0d51c181a1010b0fa849de0a3">_STE_rate_max</a> = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a0314f10a024ad65980a32092108ac4b2">_max_climb_rate</a> * <a class="code" href="../../db/d35/geo_8h.html#a32a64125a796fad5c13297499d50b082">CONSTANTS_ONE_G</a>;</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;    <span class="comment">// Calculate the specific total energy lower rate limits from the min throttle sink rate</span></div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a555f603406804cb69ac4d04a4042ee1f">_STE_rate_min</a> = - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a6b0824db5aebc3da94dfc5d9b4171105">_min_sink_rate</a> * <a class="code" href="../../db/d35/geo_8h.html#a32a64125a796fad5c13297499d50b082">CONSTANTS_ONE_G</a>;</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;}</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;</div><div class="line"><a name="l00582"></a><span class="lineno"><a class="line" href="../../d1/d1f/class_t_e_c_s.html#a6aeedcf79e4323b84da462c9e6616be8">  582</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a6aeedcf79e4323b84da462c9e6616be8">TECS::update_pitch_throttle</a>(<span class="keyword">const</span> <a class="code" href="../../d4/d11/classmatrix_1_1_dcm.html">matrix::Dcmf</a> &amp;rotMat, <span class="keywordtype">float</span> pitch, <span class="keywordtype">float</span> baro_altitude, <span class="keywordtype">float</span> hgt_setpoint,</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;                 <span class="keywordtype">float</span> EAS_setpoint, <span class="keywordtype">float</span> indicated_airspeed, <span class="keywordtype">float</span> eas_to_tas, <span class="keywordtype">bool</span> climb_out_setpoint, <span class="keywordtype">float</span> pitch_min_climbout,</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;                 <span class="keywordtype">float</span> throttle_min, <span class="keywordtype">float</span> throttle_max, <span class="keywordtype">float</span> throttle_cruise, <span class="keywordtype">float</span> pitch_limit_min, <span class="keywordtype">float</span> pitch_limit_max)</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;{</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;    <span class="comment">// Calculate the time since last update (seconds)</span></div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;    uint64_t now = <a class="code" href="../../d2/d53/ecl_8h.html#aea508d88b103ed107003d0a4b582b257">ecl_absolute_time</a>();</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a3ab0de013572380094a825d89e31365e">_dt</a> = <a class="code" href="../../dd/d47/namespacemath.html#a4a49a65edaf29055a3cb021908a031d7">constrain</a>((now - <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a491d4df45e601faaf15d149f00ba5d4b">_pitch_update_timestamp</a>) * 1e-6<a class="code" href="../../d8/da1/integration_8cpp.html#af5ba872dd09316732300733cc164ac1a">f</a>, <a class="code" href="../../db/da1/tecs_8cpp.html#a31dce443d7ddc17762497a06a865d8b6">DT_MIN</a>, <a class="code" href="../../db/da1/tecs_8cpp.html#a85417aeee491c2add265c8041e690ec0">DT_MAX</a>);</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;    <span class="comment">// Set class variables from inputs</span></div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a41f29be4495546610a800fb13e74368b">_throttle_setpoint_max</a> = throttle_max;</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#afa455a481e8b6cd23febab3ba52b547e">_throttle_setpoint_min</a> = throttle_min;</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a11358a70d4e805a267126195a7f1f277">_pitch_setpoint_max</a> = pitch_limit_max;</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#af92cd0c66cd8a6cf5f57b608c90347c4">_pitch_setpoint_min</a> = pitch_limit_min;</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a3779fae0c2dc512fd4640b5f78b8b935">_climbout_mode_active</a> = climb_out_setpoint;</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;    <span class="comment">// Initialize selected states and variables as required</span></div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a3c9071e0e57efc5e8570212f629bab17">_initialize_states</a>(pitch, throttle_cruise, baro_altitude, pitch_min_climbout, eas_to_tas);</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;    <span class="comment">// Don&#39;t run TECS control algorithms when not in flight</span></div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a4323d25b277e12fd373be58e3110cdab">_in_air</a>) {</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;    }</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;    <span class="comment">// Update the true airspeed state estimate</span></div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#ad80df2b3b140f116e244b619687f5033">_update_speed_states</a>(EAS_setpoint, indicated_airspeed, eas_to_tas);</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    <span class="comment">// Calculate rate limits for specific total energy</span></div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a4732c2d116797890c55e3c6d11663b2d">_update_STE_rate_lim</a>();</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;    <span class="comment">// Detect an underspeed condition</span></div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a77bfca668f7e22596ff8c3bf624a4eb7">_detect_underspeed</a>();</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;    <span class="comment">// Detect an uncommanded descent caused by an unachievable airspeed demand</span></div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a744cffdf8757b70e4051f05afa078922">_detect_uncommanded_descent</a>();</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    <span class="comment">// Calculate the demanded true airspeed</span></div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#af1b423dec94a3bee2c7951e2c20fc9a8">_update_speed_setpoint</a>();</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;    <span class="comment">// Calculate the demanded height</span></div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a52d4b31866f3a53e2d1fb2c08324a8c0">_update_height_setpoint</a>(hgt_setpoint, baro_altitude);</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;    <span class="comment">// Calculate the specific energy values required by the control loop</span></div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a9df3e59fc5b1e294c7aa3f3c21c48f1b">_update_energy_estimates</a>();</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;    <span class="comment">// Calculate the throttle demand</span></div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#aa46d349335c601e995746ea03306526b">_update_throttle_setpoint</a>(throttle_cruise, rotMat);</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;    <span class="comment">// Calculate the pitch demand</span></div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a1f75a0a5bda6c6708b8f02b01ec68da5">_update_pitch_setpoint</a>();</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;    <span class="comment">// Update time stamps</span></div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;    <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a491d4df45e601faaf15d149f00ba5d4b">_pitch_update_timestamp</a> = now;</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;    <span class="comment">// Set TECS mode for next frame</span></div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#ab809ed3eda881d853dc4b2a8b4db3bc1">_underspeed_detected</a>) {</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;        _tecs_mode = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a1d17f3eecc070834c5204c2dcb527072ad6fff4cd005b255134efb30748378815">ECL_TECS_MODE_UNDERSPEED</a>;</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#aca64b0d6f48ae591bf07a138a90ddfa3">_uncommanded_descent_recovery</a>) {</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;        _tecs_mode = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a1d17f3eecc070834c5204c2dcb527072a1ae6b2c41ca5ee5717407314b2f1f971">ECL_TECS_MODE_BAD_DESCENT</a>;</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1f/class_t_e_c_s.html#a3779fae0c2dc512fd4640b5f78b8b935">_climbout_mode_active</a>) {</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;        _tecs_mode = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a1d17f3eecc070834c5204c2dcb527072a0d0ecda23f3b16dd0ef28a5cf11673d0">ECL_TECS_MODE_CLIMBOUT</a>;</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;        <span class="comment">// This is the default operation mode</span></div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;        _tecs_mode = <a class="code" href="../../d1/d1f/class_t_e_c_s.html#a1d17f3eecc070834c5204c2dcb527072a76e9e424045f51df34be8ca2541bff54">ECL_TECS_MODE_NORMAL</a>;</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;    }</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;}</div><div class="ttc" id="namespacemath_html_a4a49a65edaf29055a3cb021908a031d7"><div class="ttname"><a href="../../dd/d47/namespacemath.html#a4a49a65edaf29055a3cb021908a031d7">math::constrain</a></div><div class="ttdeci">constexpr _Tp constrain(_Tp val, _Tp min_val, _Tp max_val)</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d34/_limits_8hpp_source.html#l00066">Limits.hpp:66</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a18296ff6e8c3066645c4ad2f4b1fdc48"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a18296ff6e8c3066645c4ad2f4b1fdc48">TECS::_TAS_min</a></div><div class="ttdeci">float _TAS_min</div><div class="ttdoc">true airpeed demand lower limit (m/sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00227">tecs.h:227</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a591ee0a89db163f0dadda75ac35184ee"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a591ee0a89db163f0dadda75ac35184ee">TECS::_pitch_setpoint_unc</a></div><div class="ttdeci">float _pitch_setpoint_unc</div><div class="ttdoc">pitch demand before limiting (rad) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00243">tecs.h:243</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a778f00ba2f171ea1783bbb9795a264c5"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a778f00ba2f171ea1783bbb9795a264c5">TECS::_SPE_rate</a></div><div class="ttdeci">float _SPE_rate</div><div class="ttdoc">specific potential energy rate estimate (m**2/sec**3) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00258">tecs.h:258</a></div></div>
<div class="ttc" id="tecs_8h_html"><div class="ttname"><a href="../../d6/d35/tecs_8h.html">tecs.h</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_af47096e3328a512b1c573aa1afc5f031"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#af47096e3328a512b1c573aa1afc5f031">TECS::_integrator_gain</a></div><div class="ttdeci">float _integrator_gain</div><div class="ttdoc">integrator gain used by the throttle and pitch demand calculation </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00195">tecs.h:195</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a10f2b8241be721c9ac1862b1b20e9eda"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a10f2b8241be721c9ac1862b1b20e9eda">TECS::_hgt_rate_setpoint</a></div><div class="ttdeci">float _hgt_rate_setpoint</div><div class="ttdoc">demanded climb rate tracked by the TECS algorithm </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00240">tecs.h:240</a></div></div>
<div class="ttc" id="ecl_8h_html"><div class="ttname"><a href="../../d2/d53/ecl_8h.html">ecl.h</a></div><div class="ttdoc">Adapter / shim layer for system calls needed by ECL. </div></div>
<div class="ttc" id="class_t_e_c_s_html_a7a4184c3a5c301b95e93b3ca9bf26dd7"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a7a4184c3a5c301b95e93b3ca9bf26dd7">TECS::_vert_vel_state</a></div><div class="ttdeci">float _vert_vel_state</div><div class="ttdoc">complimentary filter state - height rate (m/sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00212">tecs.h:212</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a70933c91f037cd6accca28805a8155da"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a70933c91f037cd6accca28805a8155da">TECS::_SPE_setpoint</a></div><div class="ttdeci">float _SPE_setpoint</div><div class="ttdoc">specific potential energy demand (m**2/sec**2) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00252">tecs.h:252</a></div></div>
<div class="ttc" id="tecs_8cpp_html_a85417aeee491c2add265c8041e690ec0"><div class="ttname"><a href="../../db/da1/tecs_8cpp.html#a85417aeee491c2add265c8041e690ec0">DT_MAX</a></div><div class="ttdeci">static constexpr float DT_MAX</div><div class="ttdoc">max value of _dt allowed before a filter state reset is performed (sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../db/da1/tecs_8cpp_source.html#l00044">tecs.cpp:44</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_af745ff4a477a38403bb578d9b5577f55"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#af745ff4a477a38403bb578d9b5577f55">TECS::_hgt_setpoint</a></div><div class="ttdeci">float _hgt_setpoint</div><div class="ttdoc">demanded height tracked by the TECS algorithm (m) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00235">tecs.h:235</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a72195fb04456d9ce36e6de757cb02660"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a72195fb04456d9ce36e6de757cb02660">TECS::_height_error_gain</a></div><div class="ttdeci">float _height_error_gain</div><div class="ttdoc">gain from height error to demanded climb rate (1/sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00199">tecs.h:199</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a11358a70d4e805a267126195a7f1f277"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a11358a70d4e805a267126195a7f1f277">TECS::_pitch_setpoint_max</a></div><div class="ttdeci">float _pitch_setpoint_max</div><div class="ttdoc">pitch demand upper limit (rad) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00248">tecs.h:248</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a54a4fe1ece68608c176add392ab68184"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a54a4fe1ece68608c176add392ab68184">TECS::_hgt_setpoint_prev</a></div><div class="ttdeci">float _hgt_setpoint_prev</div><div class="ttdoc">previous value of _hgt_setpoint after noise filtering and rate limiting (m) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00237">tecs.h:237</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_aca64b0d6f48ae591bf07a138a90ddfa3"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#aca64b0d6f48ae591bf07a138a90ddfa3">TECS::_uncommanded_descent_recovery</a></div><div class="ttdeci">bool _uncommanded_descent_recovery</div><div class="ttdoc">true when a continuous descent caused by an unachievable airspeed demand has been detected ...</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00274">tecs.h:274</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a3f2d95c1eb8f4cee7bd7f2b61c908953"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a3f2d95c1eb8f4cee7bd7f2b61c908953">TECS::_vert_accel_limit</a></div><div class="ttdeci">float _vert_accel_limit</div><div class="ttdoc">magnitude of the maximum vertical acceleration allowed (m/sec**2) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00196">tecs.h:196</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_ab8e692959353fac04c1e2b4b62f06425"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#ab8e692959353fac04c1e2b4b62f06425">TECS::_tas_rate_state</a></div><div class="ttdeci">float _tas_rate_state</div><div class="ttdoc">complimentary filter state - true airspeed first derivative (m/sec**2) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00214">tecs.h:214</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_ad80df2b3b140f116e244b619687f5033"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#ad80df2b3b140f116e244b619687f5033">TECS::_update_speed_states</a></div><div class="ttdeci">void _update_speed_states(float airspeed_setpoint, float indicated_airspeed, float eas_to_tas)</div><div class="ttdoc">Update the airspeed internal state using a second order complementary filter. </div><div class="ttdef"><b>Definition:</b> <a href="../../db/da1/tecs_8cpp_source.html#l00149">tecs.cpp:149</a></div></div>
<div class="ttc" id="_arm_authorization_8cpp_html_af06c723c3b5220b3ef9839275a0cf051"><div class="ttname"><a href="../../d3/dc0/_arm_authorization_8cpp.html#af06c723c3b5220b3ef9839275a0cf051">state</a></div><div class="ttdeci">static enum @74 state</div></div>
<div class="ttc" id="class_t_e_c_s_html_a9540da1f79d7eb6001bb843a6d9e1e0d"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a9540da1f79d7eb6001bb843a6d9e1e0d">TECS::_throttle_slewrate</a></div><div class="ttdeci">float _throttle_slewrate</div><div class="ttdoc">throttle demand slew rate limit (1/sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00204">tecs.h:204</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a77bfca668f7e22596ff8c3bf624a4eb7"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a77bfca668f7e22596ff8c3bf624a4eb7">TECS::_detect_underspeed</a></div><div class="ttdeci">void _detect_underspeed()</div><div class="ttdoc">Detect if the system is not capable of maintaining airspeed. </div><div class="ttdef"><b>Definition:</b> <a href="../../db/da1/tecs_8cpp_source.html#l00268">tecs.cpp:268</a></div></div>
<div class="ttc" id="geo_8h_html"><div class="ttname"><a href="../../db/d35/geo_8h.html">geo.h</a></div><div class="ttdoc">Definition of geo / math functions to perform geodesic calculations. </div></div>
<div class="ttc" id="class_t_e_c_s_html_a6b0824db5aebc3da94dfc5d9b4171105"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a6b0824db5aebc3da94dfc5d9b4171105">TECS::_min_sink_rate</a></div><div class="ttdeci">float _min_sink_rate</div><div class="ttdoc">sink rate produced by min allowed throttle (m/sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00189">tecs.h:189</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_ae405982aa408beacb0a07f4455b27992"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#ae405982aa408beacb0a07f4455b27992">TECS::_throttle_integ_state</a></div><div class="ttdeci">float _throttle_integ_state</div><div class="ttdoc">throttle integrator state </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00218">tecs.h:218</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a491d4df45e601faaf15d149f00ba5d4b"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a491d4df45e601faaf15d149f00ba5d4b">TECS::_pitch_update_timestamp</a></div><div class="ttdeci">uint64_t _pitch_update_timestamp</div><div class="ttdoc">last timestamp of the pitch function call </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00183">tecs.h:183</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a3779fae0c2dc512fd4640b5f78b8b935"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a3779fae0c2dc512fd4640b5f78b8b935">TECS::_climbout_mode_active</a></div><div class="ttdeci">bool _climbout_mode_active</div><div class="ttdoc">true when in climbout mode </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00275">tecs.h:275</a></div></div>
<div class="ttc" id="tecs_8cpp_html_a31dce443d7ddc17762497a06a865d8b6"><div class="ttname"><a href="../../db/da1/tecs_8cpp.html#a31dce443d7ddc17762497a06a865d8b6">DT_MIN</a></div><div class="ttdeci">static constexpr float DT_MIN</div><div class="ttdoc">minimum allowed value of _dt (sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../db/da1/tecs_8cpp_source.html#l00043">tecs.cpp:43</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a555f603406804cb69ac4d04a4042ee1f"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a555f603406804cb69ac4d04a4042ee1f">TECS::_STE_rate_min</a></div><div class="ttdeci">float _STE_rate_min</div><div class="ttdoc">specific total energy rate lower limit acheived when throttle is at _throttle_setpoint_min (m**2/sec*...</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00245">tecs.h:245</a></div></div>
<div class="ttc" id="classmatrix_1_1_dcm_html"><div class="ttname"><a href="../../d4/d11/classmatrix_1_1_dcm.html">matrix::Dcm&lt; float &gt;</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_aa46d349335c601e995746ea03306526b"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#aa46d349335c601e995746ea03306526b">TECS::_update_throttle_setpoint</a></div><div class="ttdeci">void _update_throttle_setpoint(float throttle_cruise, const matrix::Dcmf &amp;rotMat)</div><div class="ttdoc">Update throttle setpoint. </div><div class="ttdef"><b>Definition:</b> <a href="../../db/da1/tecs_8cpp_source.html#l00304">tecs.cpp:304</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_afa455a481e8b6cd23febab3ba52b547e"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#afa455a481e8b6cd23febab3ba52b547e">TECS::_throttle_setpoint_min</a></div><div class="ttdeci">float _throttle_setpoint_min</div><div class="ttdoc">normalised throttle lower limit </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00247">tecs.h:247</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_aaa1bdb9455890bb186ffb899875fc74b"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#aaa1bdb9455890bb186ffb899875fc74b">TECS::_SKE_estimate</a></div><div class="ttdeci">float _SKE_estimate</div><div class="ttdoc">specific kinetic energy estimate (m**2/sec**2) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00257">tecs.h:257</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a2cd6cd2c99aac892c8cc41a0392dba92"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a2cd6cd2c99aac892c8cc41a0392dba92">TECS::_speed_derivative</a></div><div class="ttdeci">float _speed_derivative</div><div class="ttdoc">rate of change of speed along X axis (m/sec**2) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00222">tecs.h:222</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a2dabe0c9724c35d4f5f14b690902edae"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a2dabe0c9724c35d4f5f14b690902edae">TECS::_pitch_integ_state</a></div><div class="ttdeci">float _pitch_integ_state</div><div class="ttdoc">pitch integrator state (rad) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00219">tecs.h:219</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a51126f8571149af17e701829e6fc31d3"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a51126f8571149af17e701829e6fc31d3">TECS::_STE_rate_error</a></div><div class="ttdeci">float _STE_rate_error</div><div class="ttdoc">specific total energy rate error (m**2/sec**3) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00263">tecs.h:263</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a81e71ebe1d88cb2889cc880adcc61b19"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a81e71ebe1d88cb2889cc880adcc61b19">TECS::_pitch_damping_gain</a></div><div class="ttdeci">float _pitch_damping_gain</div><div class="ttdoc">damping gain of the pitch demand calculation (sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00193">tecs.h:193</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a63dc43165dd4662b98e51f5ac87d15f0"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a63dc43165dd4662b98e51f5ac87d15f0">TECS::_tas_state</a></div><div class="ttdeci">float _tas_state</div><div class="ttdoc">complimentary filter state - true airspeed (m/sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00215">tecs.h:215</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a1d17f3eecc070834c5204c2dcb527072a0d0ecda23f3b16dd0ef28a5cf11673d0"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a1d17f3eecc070834c5204c2dcb527072a0d0ecda23f3b16dd0ef28a5cf11673d0">TECS::ECL_TECS_MODE_CLIMBOUT</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00098">tecs.h:98</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a35a4dc41fd04a11df4f449a9d6210544"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a35a4dc41fd04a11df4f449a9d6210544">TECS::_pitch_time_constant</a></div><div class="ttdeci">float _pitch_time_constant</div><div class="ttdoc">control time constant used by the pitch demand calculation (sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00191">tecs.h:191</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a9897752b5b90aa5abb1fcf46b90f5889"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a9897752b5b90aa5abb1fcf46b90f5889">TECS::_SKE_setpoint</a></div><div class="ttdeci">float _SKE_setpoint</div><div class="ttdoc">specific kinetic energy demand (m**2/sec**2) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00253">tecs.h:253</a></div></div>
<div class="ttc" id="classmatrix_1_1_vector3_html"><div class="ttname"><a href="../../d3/d87/classmatrix_1_1_vector3.html">matrix::Vector3</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d6a/_vector3_8hpp_source.html#l00029">Vector3.hpp:29</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a96d6a8a91a38a92ba9324210fb3416f1"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a96d6a8a91a38a92ba9324210fb3416f1">TECS::_indicated_airspeed_min</a></div><div class="ttdeci">float _indicated_airspeed_min</div><div class="ttdoc">equivalent airspeed demand lower limit (m/sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00202">tecs.h:202</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a500bb4f60008185cf2554b503109670a"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a500bb4f60008185cf2554b503109670a">TECS::_throttle_damping_gain</a></div><div class="ttdeci">float _throttle_damping_gain</div><div class="ttdoc">damping gain of the throttle demand calculation (sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00194">tecs.h:194</a></div></div>
<div class="ttc" id="geo_8h_html_a32a64125a796fad5c13297499d50b082"><div class="ttname"><a href="../../db/d35/geo_8h.html#a32a64125a796fad5c13297499d50b082">CONSTANTS_ONE_G</a></div><div class="ttdeci">static constexpr float CONSTANTS_ONE_G</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d35/geo_8h_source.html#l00051">geo.h:51</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a1f75a0a5bda6c6708b8f02b01ec68da5"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a1f75a0a5bda6c6708b8f02b01ec68da5">TECS::_update_pitch_setpoint</a></div><div class="ttdeci">void _update_pitch_setpoint()</div><div class="ttdoc">Update the pitch setpoint. </div><div class="ttdef"><b>Definition:</b> <a href="../../db/da1/tecs_8cpp_source.html#l00426">tecs.cpp:426</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a0d597bd2728311e9804ea8b1ef1f5efa"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a0d597bd2728311e9804ea8b1ef1f5efa">TECS::_TAS_max</a></div><div class="ttdeci">float _TAS_max</div><div class="ttdoc">true airpeed demand upper limit (m/sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00226">tecs.h:226</a></div></div>
<div class="ttc" id="ecl_8h_html_aea508d88b103ed107003d0a4b582b257"><div class="ttname"><a href="../../d2/d53/ecl_8h.html#aea508d88b103ed107003d0a4b582b257">ecl_absolute_time</a></div><div class="ttdeci">#define ecl_absolute_time()</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d53/ecl_8h_source.html#l00085">ecl.h:85</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a93742f830629d1a8ef06ee9d374a1233"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a93742f830629d1a8ef06ee9d374a1233">TECS::_pitch_speed_weight</a></div><div class="ttdeci">float _pitch_speed_weight</div><div class="ttdoc">speed control weighting used by pitch demand calculation </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00198">tecs.h:198</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a5c948a3760ef7842f6cceeb1e2fa37e1"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a5c948a3760ef7842f6cceeb1e2fa37e1">TECS::_TAS_setpoint_last</a></div><div class="ttdeci">float _TAS_setpoint_last</div><div class="ttdoc">previous true airpeed demand (m/sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00229">tecs.h:229</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a370014b30b390f27086b89f8fba2c746"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a370014b30b390f27086b89f8fba2c746">TECS::_last_throttle_setpoint</a></div><div class="ttdeci">float _last_throttle_setpoint</div><div class="ttdoc">throttle demand rate limiter state (1/sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00220">tecs.h:220</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a8e12e8101f533b0f000f142ad509a545"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a8e12e8101f533b0f000f142ad509a545">TECS::_SKE_rate</a></div><div class="ttdeci">float _SKE_rate</div><div class="ttdoc">specific kinetic energy rate estimate (m**2/sec**3) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00259">tecs.h:259</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a7a2699e5cf8e98357087943d536277c2"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a7a2699e5cf8e98357087943d536277c2">TECS::_state_update_timestamp</a></div><div class="ttdeci">uint64_t _state_update_timestamp</div><div class="ttdoc">last timestamp of the 50 Hz function call </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00181">tecs.h:181</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a054d1b84c6719847ae15e908ca616642"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a054d1b84c6719847ae15e908ca616642">TECS::_STE_error</a></div><div class="ttdeci">float _STE_error</div><div class="ttdoc">specific total energy error (m**2/sec**2) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00262">tecs.h:262</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a5578ae0b9aaf061d02acd77a1b64f43b"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a5578ae0b9aaf061d02acd77a1b64f43b">TECS::_max_sink_rate</a></div><div class="ttdeci">float _max_sink_rate</div><div class="ttdoc">maximum safe sink rate (m/sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00190">tecs.h:190</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a746eb83d156c47eecb28e0fb6b2fc1e5"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a746eb83d156c47eecb28e0fb6b2fc1e5">TECS::_SEB_error</a></div><div class="ttdeci">float _SEB_error</div><div class="ttdoc">specific energy balance error (m**2/sec**2) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00264">tecs.h:264</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a41f29be4495546610a800fb13e74368b"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a41f29be4495546610a800fb13e74368b">TECS::_throttle_setpoint_max</a></div><div class="ttdeci">float _throttle_setpoint_max</div><div class="ttdoc">normalised throttle upper limit </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00246">tecs.h:246</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_ae627d8fc2349e502b6021326e4959a32"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#ae627d8fc2349e502b6021326e4959a32">TECS::_load_factor_correction</a></div><div class="ttdeci">float _load_factor_correction</div><div class="ttdoc">gain from normal load factor increase to total energy rate demand (m**2/sec**3) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00197">tecs.h:197</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a62a53dfcd8944ef8874db7ab9c7865dc"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a62a53dfcd8944ef8874db7ab9c7865dc">TECS::_hgt_setpoint_in_prev</a></div><div class="ttdeci">float _hgt_setpoint_in_prev</div><div class="ttdoc">previous value of _hgt_setpoint after noise filtering (m) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00236">tecs.h:236</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_aecdf93951f7e0e7d056383826debfcf6"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#aecdf93951f7e0e7d056383826debfcf6">TECS::airspeed_sensor_enabled</a></div><div class="ttdeci">bool airspeed_sensor_enabled()</div><div class="ttdoc">Get the current airspeed status. </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00062">tecs.h:62</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a94813442c376e5a4f472cdecf45f89b6"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a94813442c376e5a4f472cdecf45f89b6">TECS::_last_pitch_setpoint</a></div><div class="ttdeci">float _last_pitch_setpoint</div><div class="ttdoc">pitch demand rate limiter state (rad/sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00221">tecs.h:221</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_af92cd0c66cd8a6cf5f57b608c90347c4"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#af92cd0c66cd8a6cf5f57b608c90347c4">TECS::_pitch_setpoint_min</a></div><div class="ttdeci">float _pitch_setpoint_min</div><div class="ttdoc">pitch demand lower limit (rad) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00249">tecs.h:249</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a3c9071e0e57efc5e8570212f629bab17"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a3c9071e0e57efc5e8570212f629bab17">TECS::_initialize_states</a></div><div class="ttdeci">void _initialize_states(float pitch, float throttle_cruise, float baro_altitude, float pitch_min_climbout, float eas_to_tas)</div><div class="ttdoc">Initialize the controller. </div><div class="ttdef"><b>Definition:</b> <a href="../../db/da1/tecs_8cpp_source.html#l00518">tecs.cpp:518</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a247b49471892cbe8a414d5981944b639"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a247b49471892cbe8a414d5981944b639">TECS::_TAS_setpoint</a></div><div class="ttdeci">float _TAS_setpoint</div><div class="ttdoc">current airpeed demand (m/sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00228">tecs.h:228</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_ad3a8467e9cf0fd678c9cd4489c37419c"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#ad3a8467e9cf0fd678c9cd4489c37419c">TECS::_EAS</a></div><div class="ttdeci">float _EAS</div><div class="ttdoc">equivalent airspeed (m/sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00225">tecs.h:225</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_ad32b8a2728dc4aff6fe09447f19e5bbc"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#ad32b8a2728dc4aff6fe09447f19e5bbc">TECS::_detect_underspeed_enabled</a></div><div class="ttdeci">bool _detect_underspeed_enabled</div><div class="ttdoc">true when underspeed detection is enabled </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00273">tecs.h:273</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a3ab0de013572380094a825d89e31365e"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a3ab0de013572380094a825d89e31365e">TECS::_dt</a></div><div class="ttdeci">float _dt</div><div class="ttdoc">Time since last update of main TECS loop (sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00268">tecs.h:268</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_ad55696d5bee9f3ac4bc80a0f85a885bc"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#ad55696d5bee9f3ac4bc80a0f85a885bc">TECS::_SPE_estimate</a></div><div class="ttdeci">float _SPE_estimate</div><div class="ttdoc">specific potential energy estimate (m**2/sec**2) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00256">tecs.h:256</a></div></div>
<div class="ttc" id="integration_8cpp_html_af5ba872dd09316732300733cc164ac1a"><div class="ttname"><a href="../../d8/da1/integration_8cpp.html#af5ba872dd09316732300733cc164ac1a">f</a></div><div class="ttdeci">Vector&lt; float, 6 &gt; f(float t, const Matrix&lt; float, 6, 1 &gt; &amp;, const Matrix&lt; float, 3, 1 &gt; &amp;)</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/da1/integration_8cpp_source.html#l00008">integration.cpp:8</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a4323d25b277e12fd373be58e3110cdab"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a4323d25b277e12fd373be58e3110cdab">TECS::_in_air</a></div><div class="ttdeci">bool _in_air</div><div class="ttdoc">true when the vehicle is flying </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00278">tecs.h:278</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a38c44464c8e2bf1094fd1e78d2ce33cb"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a38c44464c8e2bf1094fd1e78d2ce33cb">TECS::_hgt_setpoint_adj</a></div><div class="ttdeci">float _hgt_setpoint_adj</div><div class="ttdoc">demanded height used by the control loops after all filtering has been applied (m) ...</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00238">tecs.h:238</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a5a1c7de2bee26a58eff5e6044a1fc50d"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a5a1c7de2bee26a58eff5e6044a1fc50d">TECS::_SEB_rate_error</a></div><div class="ttdeci">float _SEB_rate_error</div><div class="ttdoc">specific energy balance rate error (m**2/sec**3) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00265">tecs.h:265</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_abc8d88ad1ae9837410f75087a2f2379b"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#abc8d88ad1ae9837410f75087a2f2379b">TECS::_height_setpoint_gain_ff</a></div><div class="ttdeci">float _height_setpoint_gain_ff</div><div class="ttdoc">gain from height demand derivative to demanded climb rate </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00200">tecs.h:200</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_acbc17a214656270c156f8c5ce731c611"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#acbc17a214656270c156f8c5ce731c611">TECS::_pitch_setpoint</a></div><div class="ttdeci">float _pitch_setpoint</div><div class="ttdoc">pitch angle demand (radians) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00208">tecs.h:208</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a8a585f4e93479d4ab930a63bea3229a8"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a8a585f4e93479d4ab930a63bea3229a8">TECS::_TAS_rate_setpoint</a></div><div class="ttdeci">float _TAS_rate_setpoint</div><div class="ttdoc">true airspeed rate demand tracked by the TECS algorithm (m/sec**2) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00232">tecs.h:232</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_ac9dffa45ad1bfadc69e5e3b75e2de25d"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#ac9dffa45ad1bfadc69e5e3b75e2de25d">TECS::_vert_accel_state</a></div><div class="ttdeci">float _vert_accel_state</div><div class="ttdoc">complimentary filter state - height second derivative (m/sec**2) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00211">tecs.h:211</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a1d17f3eecc070834c5204c2dcb527072ad6fff4cd005b255134efb30748378815"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a1d17f3eecc070834c5204c2dcb527072ad6fff4cd005b255134efb30748378815">TECS::ECL_TECS_MODE_UNDERSPEED</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00096">tecs.h:96</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a06802c5fc4a2aee207156706117d889d"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a06802c5fc4a2aee207156706117d889d">TECS::_states_initalized</a></div><div class="ttdeci">bool _states_initalized</div><div class="ttdoc">true when TECS states have been iniitalized </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00277">tecs.h:277</a></div></div>
<div class="ttc" id="namespacemath_html_a0590ec5bbbdad228b5a47307af425055"><div class="ttname"><a href="../../dd/d47/namespacemath.html#a0590ec5bbbdad228b5a47307af425055">math::min</a></div><div class="ttdeci">constexpr _Tp min(_Tp a, _Tp b)</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d34/_limits_8hpp_source.html#l00054">Limits.hpp:54</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_ab809ed3eda881d853dc4b2a8b4db3bc1"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#ab809ed3eda881d853dc4b2a8b4db3bc1">TECS::_underspeed_detected</a></div><div class="ttdeci">bool _underspeed_detected</div><div class="ttdoc">true when an underspeed condition has been detected </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00272">tecs.h:272</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_ac1170fb4bae85e2229562758ce932500"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#ac1170fb4bae85e2229562758ce932500">TECS::_SPE_rate_setpoint</a></div><div class="ttdeci">float _SPE_rate_setpoint</div><div class="ttdoc">specific potential energy rate demand (m**2/sec**3) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00254">tecs.h:254</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a1d17f3eecc070834c5204c2dcb527072a1ae6b2c41ca5ee5717407314b2f1f971"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a1d17f3eecc070834c5204c2dcb527072a1ae6b2c41ca5ee5717407314b2f1f971">TECS::ECL_TECS_MODE_BAD_DESCENT</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00097">tecs.h:97</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a65589176395cccd296be86762d2f336f"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a65589176395cccd296be86762d2f336f">TECS::_EAS_setpoint</a></div><div class="ttdeci">float _EAS_setpoint</div><div class="ttdoc">Equivalent airspeed demand (m/sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00230">tecs.h:230</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a6aeedcf79e4323b84da462c9e6616be8"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a6aeedcf79e4323b84da462c9e6616be8">TECS::update_pitch_throttle</a></div><div class="ttdeci">void update_pitch_throttle(const matrix::Dcmf &amp;rotMat, float pitch, float baro_altitude, float hgt_setpoint, float EAS_setpoint, float indicated_airspeed, float eas_to_tas, bool climb_out_setpoint, float pitch_min_climbout, float throttle_min, float throttle_setpoint_max, float throttle_cruise, float pitch_limit_min, float pitch_limit_max)</div><div class="ttdoc">Update the control loop calculations. </div><div class="ttdef"><b>Definition:</b> <a href="../../db/da1/tecs_8cpp_source.html#l00582">tecs.cpp:582</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a674913a0d51c181a1010b0fa849de0a3"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a674913a0d51c181a1010b0fa849de0a3">TECS::_STE_rate_max</a></div><div class="ttdeci">float _STE_rate_max</div><div class="ttdoc">specific total energy rate upper limit achieved when throttle is at _throttle_setpoint_max (m**2/sec*...</div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00244">tecs.h:244</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_aa3615934413da852b1dfec989eb1840c"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#aa3615934413da852b1dfec989eb1840c">TECS::_hgt_setpoint_adj_prev</a></div><div class="ttdeci">float _hgt_setpoint_adj_prev</div><div class="ttdoc">value of _hgt_setpoint_adj from previous frame (m) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00239">tecs.h:239</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a744cffdf8757b70e4051f05afa078922"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a744cffdf8757b70e4051f05afa078922">TECS::_detect_uncommanded_descent</a></div><div class="ttdeci">void _detect_uncommanded_descent()</div><div class="ttdoc">Detect an uncommanded descent. </div><div class="ttdef"><b>Definition:</b> <a href="../../db/da1/tecs_8cpp_source.html#l00399">tecs.cpp:399</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a4732c2d116797890c55e3c6d11663b2d"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a4732c2d116797890c55e3c6d11663b2d">TECS::_update_STE_rate_lim</a></div><div class="ttdeci">void _update_STE_rate_lim()</div><div class="ttdoc">Calculate specific total energy rate limits. </div><div class="ttdef"><b>Definition:</b> <a href="../../db/da1/tecs_8cpp_source.html#l00573">tecs.cpp:573</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_accd03f8685f83d31331cac4c76a37d36"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#accd03f8685f83d31331cac4c76a37d36">TECS::_throttle_setpoint</a></div><div class="ttdeci">float _throttle_setpoint</div><div class="ttdoc">normalized throttle demand (0..1) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00207">tecs.h:207</a></div></div>
<div class="ttc" id="namespacemath_html_ad42187b143e9e0e96bb14c7edcfbfef6"><div class="ttname"><a href="../../dd/d47/namespacemath.html#ad42187b143e9e0e96bb14c7edcfbfef6">math::max</a></div><div class="ttdeci">constexpr _Tp max(_Tp a, _Tp b)</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d34/_limits_8hpp_source.html#l00060">Limits.hpp:60</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a0314f10a024ad65980a32092108ac4b2"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a0314f10a024ad65980a32092108ac4b2">TECS::_max_climb_rate</a></div><div class="ttdeci">float _max_climb_rate</div><div class="ttdoc">climb rate produced by max allowed throttle (m/sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00188">tecs.h:188</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_aab6412a9450a4430487b7b1cffa7c38f"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#aab6412a9450a4430487b7b1cffa7c38f">TECS::update_vehicle_state_estimates</a></div><div class="ttdeci">void update_vehicle_state_estimates(float airspeed, const matrix::Dcmf &amp;rotMat, const matrix::Vector3f &amp;accel_body, bool altitude_lock, bool in_air, float altitude, bool vz_valid, float vz, float az)</div><div class="ttdoc">Updates the following vehicle kineamtic state estimates: Vertical position, velocity and acceleration...</div><div class="ttdef"><b>Definition:</b> <a href="../../db/da1/tecs_8cpp_source.html#l00057">tecs.cpp:57</a></div></div>
<div class="ttc" id="px4io_8c_html_a778e38aa889751afffa2dea6b803e67a"><div class="ttname"><a href="../../dd/d87/px4io_8c.html#a778e38aa889751afffa2dea6b803e67a">dt</a></div><div class="ttdeci">float dt</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d87/px4io_8c_source.html#l00073">px4io.c:73</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a78bbe16f2037a98a7080891f68114db2"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a78bbe16f2037a98a7080891f68114db2">TECS::_SKE_rate_setpoint</a></div><div class="ttdeci">float _SKE_rate_setpoint</div><div class="ttdoc">specific kinetic energy rate demand (m**2/sec**3) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00255">tecs.h:255</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a52d4b31866f3a53e2d1fb2c08324a8c0"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a52d4b31866f3a53e2d1fb2c08324a8c0">TECS::_update_height_setpoint</a></div><div class="ttdeci">void _update_height_setpoint(float desired, float state)</div><div class="ttdoc">Update the desired height. </div><div class="ttdef"><b>Definition:</b> <a href="../../db/da1/tecs_8cpp_source.html#l00222">tecs.cpp:222</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a9b530553ef9e6e2b09625bbec5ef8b7c"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a9b530553ef9e6e2b09625bbec5ef8b7c">TECS::_TAS_setpoint_adj</a></div><div class="ttdeci">float _TAS_setpoint_adj</div><div class="ttdoc">true airspeed demand tracked by the TECS algorithm (m/sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00231">tecs.h:231</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_af1b423dec94a3bee2c7951e2c20fc9a8"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#af1b423dec94a3bee2c7951e2c20fc9a8">TECS::_update_speed_setpoint</a></div><div class="ttdeci">void _update_speed_setpoint()</div><div class="ttdoc">Update the desired airspeed. </div><div class="ttdef"><b>Definition:</b> <a href="../../db/da1/tecs_8cpp_source.html#l00199">tecs.cpp:199</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_ab03d4d09d85e595746b83c89d845d01d"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#ab03d4d09d85e595746b83c89d845d01d">TECS::_hgt_estimate_freq</a></div><div class="ttdeci">float _hgt_estimate_freq</div><div class="ttdoc">cross-over frequency of the height rate complementary filter (rad/sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00186">tecs.h:186</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_aa58f800b3a774edca8b400a4f70c616f"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#aa58f800b3a774edca8b400a4f70c616f">TECS::_throttle_time_constant</a></div><div class="ttdeci">float _throttle_time_constant</div><div class="ttdoc">control time constant used by the throttle demand calculation (sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00192">tecs.h:192</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a9df3e59fc5b1e294c7aa3f3c21c48f1b"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a9df3e59fc5b1e294c7aa3f3c21c48f1b">TECS::_update_energy_estimates</a></div><div class="ttdeci">void _update_energy_estimates()</div><div class="ttdoc">Update specific energy. </div><div class="ttdef"><b>Definition:</b> <a href="../../db/da1/tecs_8cpp_source.html#l00285">tecs.cpp:285</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_aa4b4c2be7382fc9e4b89467549273222"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#aa4b4c2be7382fc9e4b89467549273222">TECS::_tas_estimate_freq</a></div><div class="ttdeci">float _tas_estimate_freq</div><div class="ttdoc">cross-over frequency of the true airspeed complementary filter (rad/sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00187">tecs.h:187</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a1d17f3eecc070834c5204c2dcb527072a76e9e424045f51df34be8ca2541bff54"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a1d17f3eecc070834c5204c2dcb527072a76e9e424045f51df34be8ca2541bff54">TECS::ECL_TECS_MODE_NORMAL</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00095">tecs.h:95</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a16e8ffefa1c5098d11fb7b4a3a11278c"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a16e8ffefa1c5098d11fb7b4a3a11278c">TECS::_speed_error_gain</a></div><div class="ttdeci">float _speed_error_gain</div><div class="ttdoc">gain from speed error to demanded speed rate (1/sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00201">tecs.h:201</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a7b265b047753556de1e3fb8ee54987e0"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a7b265b047753556de1e3fb8ee54987e0">TECS::_speed_update_timestamp</a></div><div class="ttdeci">uint64_t _speed_update_timestamp</div><div class="ttdoc">last timestamp of the speed function call </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00182">tecs.h:182</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_ae680021e0c92c9da05429c915b415d7e"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#ae680021e0c92c9da05429c915b415d7e">TECS::_vert_pos_state</a></div><div class="ttdeci">float _vert_pos_state</div><div class="ttdoc">complimentary filter state - height (m) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00213">tecs.h:213</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a9d91854786fdf8697c224df982f4ba5c"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a9d91854786fdf8697c224df982f4ba5c">TECS::DT_DEFAULT</a></div><div class="ttdeci">static constexpr float DT_DEFAULT</div><div class="ttdoc">default value for _dt (sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00269">tecs.h:269</a></div></div>
<div class="ttc" id="ecl_8h_html_a5181155e284a192217ea7e0ea70bb810"><div class="ttname"><a href="../../d2/d53/ecl_8h.html#a5181155e284a192217ea7e0ea70bb810">ISFINITE</a></div><div class="ttdeci">#define ISFINITE(x)</div><div class="ttdef"><b>Definition:</b> <a href="../../d2/d53/ecl_8h_source.html#l00100">ecl.h:100</a></div></div>
<div class="ttc" id="class_t_e_c_s_html_a03cda9f2d349d699568bc78dec8db447"><div class="ttname"><a href="../../d1/d1f/class_t_e_c_s.html#a03cda9f2d349d699568bc78dec8db447">TECS::_indicated_airspeed_max</a></div><div class="ttdeci">float _indicated_airspeed_max</div><div class="ttdoc">equivalent airspeed demand upper limit (m/sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d6/d35/tecs_8h_source.html#l00203">tecs.h:203</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="../../dir_c85d3e3c5052e9ad9ce18c6863244a25.html">lib</a></li><li class="navelem"><a class="el" href="../../dir_6f10fbb79da377506552735e446823ce.html">ecl</a></li><li class="navelem"><a class="el" href="../../dir_e3cfb7f7fcbd182edb01dfa9840b7f97.html">tecs</a></li><li class="navelem"><a class="el" href="../../db/da1/tecs_8cpp.html">tecs.cpp</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
