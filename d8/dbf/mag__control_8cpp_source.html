<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PX4 Firmware: src/lib/ecl/EKF/mag_control.cpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">PX4 Firmware
   </div>
   <div id="projectbrief">PX4 Autopilot Software http://px4.io</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d8/dbf/mag__control_8cpp_source.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">mag_control.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d8/dbf/mag__control_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/****************************************************************************</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> *   Copyright (c) 2019 Estimation and Control Library (ECL). All rights reserved.</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> * Redistribution and use in source and binary forms, with or without</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> * modification, are permitted provided that the following conditions</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> * are met:</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> * 1. Redistributions of source code must retain the above copyright</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> *    notice, this list of conditions and the following disclaimer.</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> *    notice, this list of conditions and the following disclaimer in</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> *    the documentation and/or other materials provided with the</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> *    distribution.</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> * 3. Neither the name ECL nor the names of its contributors may be</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> *    used to endorse or promote products derived from this software</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"> *    without specific prior written permission.</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE</span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment"> * COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN</span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment"> * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment"> * POSSIBILITY OF SUCH DAMAGE.</span></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment"> ****************************************************************************/</span></div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment">/**</span></div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment"> * @file mag_control.cpp</span></div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment"> * Control functions for ekf magnetic field fusion</span></div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../de/d14/ekf_8h.html">ekf.h</a>&quot;</span></div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor">#include &lt;mathlib/mathlib.h&gt;</span></div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div><div class="line"><a name="l00042"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#af7b13c3328aee801c57df71e99b3d2a2">   42</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../dc/d66/class_ekf.html#af7b13c3328aee801c57df71e99b3d2a2">Ekf::controlMagFusion</a>()</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;{</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    <a class="code" href="../../dc/d66/class_ekf.html#a0ca03003996218259d343d526f065ae3">updateMagFilter</a>();</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    <a class="code" href="../../dc/d66/class_ekf.html#ab032c45aa539ecd512d7e539bbbf38fd">checkMagFieldStrength</a>();</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <span class="comment">// If we are on ground, store the local position and time to use as a reference</span></div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    <span class="comment">// Also reset the flight alignment flag so that the mag fields will be re-initialised next time we achieve flight altitude</span></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a378bf598d2aaab4580c5bfb6567022a8">in_air</a>) {</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;        <a class="code" href="../../dc/d66/class_ekf.html#aa2c5a9b5968445e5432ddb150fcb18d2">_last_on_ground_posD</a> = <a class="code" href="../../dc/d66/class_ekf.html#acd779b7801421d846f714072ee78bbd6">_state</a>.<a class="code" href="../../de/d11/structestimator_1_1state_sample.html#a0cba220966df5150bcffcc95d01ef11f">pos</a>(2);</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;        <a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a31b4bc6b95c1c741136a688ae8028c17">mag_aligned_in_flight</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;        <a class="code" href="../../dc/d66/class_ekf.html#a82bb548da63d49e7f01339c717297695">_num_bad_flight_yaw_events</a> = 0;</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    }</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d73/class_estimator_interface.html#ae214374497f6c641a8d9a350149ec4bf">_params</a>.<a class="code" href="../../d8/d25/structestimator_1_1parameters.html#a788a99a27570b5b2d842bb929b542962">mag_fusion_type</a> &gt;= <a class="code" href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h.html#a62073e26031e8cb0c5e120bf1dda7a92">MAG_FUSE_TYPE_NONE</a>)</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;        || <a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aab89779a504dd3856b9c81d5d04cf050">mag_fault</a></div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;        || !<a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a15f198a7368ad17fad86d5e839444197">yaw_align</a>) {</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;        <a class="code" href="../../dc/d66/class_ekf.html#aa3557241350622e78d0ef053e28177dc">stopMagFusion</a>();</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    }</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../dc/d66/class_ekf.html#a4fb97af3133b0f90b205c85424dca180">canRunMagFusion</a>()) {</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a378bf598d2aaab4580c5bfb6567022a8">in_air</a>) {</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;            <a class="code" href="../../dc/d66/class_ekf.html#a1840694d8d4a1e71d2847a02d0e14964">checkHaglYawResetReq</a>();</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;            <a class="code" href="../../dc/d66/class_ekf.html#a3a5746a93bc89940139428190db96f38">runInAirYawReset</a>();</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;            <a class="code" href="../../dc/d66/class_ekf.html#a921384ecaa7912d4803add15c8d1b2e8">runVelPosReset</a>();</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;            <a class="code" href="../../dc/d66/class_ekf.html#aa73a3299bd9b9975e268bca91b385aae">runOnGroundYawReset</a>();</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;        }</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;        <span class="comment">// Determine if we should use simple magnetic heading fusion which works better when</span></div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;        <span class="comment">// there are large external disturbances or the more accurate 3-axis fusion</span></div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;        <span class="keywordflow">switch</span> (<a class="code" href="../../d5/d73/class_estimator_interface.html#ae214374497f6c641a8d9a350149ec4bf">_params</a>.<a class="code" href="../../d8/d25/structestimator_1_1parameters.html#a788a99a27570b5b2d842bb929b542962">mag_fusion_type</a>) {</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h.html#a4794f1aa83200931c08eaa60bbea11c9">MAG_FUSE_TYPE_AUTO</a>:</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;            <a class="code" href="../../dc/d66/class_ekf.html#ae6bc4a65c6605547f3a7570d1060ff0f">selectMagAuto</a>();</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h.html#a360271849b29e59bf99c44f4738ae968">MAG_FUSE_TYPE_INDOOR</a>:</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;        <span class="comment">/* fallthrough */</span></div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h.html#a692da991196dd22f9d80bdc05aa156c2">MAG_FUSE_TYPE_HEADING</a>:</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;            <a class="code" href="../../dc/d66/class_ekf.html#a0828d9e222ff448c3686d36d3eafbad3">startMagHdgFusion</a>();</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;        <span class="keywordflow">case</span> <a class="code" href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h.html#a2f1eb3709f6c848456fb6cde11c5367c">MAG_FUSE_TYPE_3D</a>:</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;            <a class="code" href="../../dc/d66/class_ekf.html#a8722aaa3baa6b8fb1a837b9478f35105">startMag3DFusion</a>();</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;        <span class="keywordflow">default</span>:</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;            <a class="code" href="../../dc/d66/class_ekf.html#ae6bc4a65c6605547f3a7570d1060ff0f">selectMagAuto</a>();</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;        }</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;        <a class="code" href="../../dc/d66/class_ekf.html#a8f27dacb50fc38aaeca8170d88b75815">checkMagDeclRequired</a>();</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;        <a class="code" href="../../dc/d66/class_ekf.html#a02303e56b30d1704f2be3e0e8a04e095">checkMagInhibition</a>();</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;        <a class="code" href="../../dc/d66/class_ekf.html#a434e228e673df0f462f033994eefb197">runMagAndMagDeclFusions</a>();</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    }</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;}</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div><div class="line"><a name="l00101"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#a0ca03003996218259d343d526f065ae3">  101</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../dc/d66/class_ekf.html#a0ca03003996218259d343d526f065ae3">Ekf::updateMagFilter</a>()</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;{</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../dc/d66/class_ekf.html#aa243905f7a54a626f293cc031cc44687">_mag_data_ready</a>) {</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;        <a class="code" href="../../dc/d66/class_ekf.html#a51ee969f6d4e139a22a52ad9a7e653a0">_mag_lpf</a>.<a class="code" href="../../dc/d8f/class_alpha_filter.html#a3e555d33f331f59097fb251f80bc8465">update</a>(<a class="code" href="../../d5/d73/class_estimator_interface.html#aebfe470fa3e331559248f516f03833e1">_mag_sample_delayed</a>.<a class="code" href="../../da/daf/structestimator_1_1mag_sample.html#a32cc19a6ee68ac84aa7b0b91c61800f4">mag</a>);</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    }</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;}</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;</div><div class="line"><a name="l00108"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#a4fb97af3133b0f90b205c85424dca180">  108</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="../../dc/d66/class_ekf.html#a4fb97af3133b0f90b205c85424dca180">Ekf::canRunMagFusion</a>()<span class="keyword"> const</span></div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    <span class="comment">// check for new magnetometer data that has fallen behind the fusion time horizon</span></div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    <span class="comment">// If we are using external vision data or GPS-heading for heading then no magnetometer fusion is used</span></div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    <span class="keywordflow">return</span> !<a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#ab43159862f360179a62284dd2da03611">ev_yaw</a> &amp;&amp; !<a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#ab8678e0a92082eaddbd6569a76cba296">gps_yaw</a> &amp;&amp; <a class="code" href="../../dc/d66/class_ekf.html#aa243905f7a54a626f293cc031cc44687">_mag_data_ready</a>;</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;}</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;</div><div class="line"><a name="l00115"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#a1840694d8d4a1e71d2847a02d0e14964">  115</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../dc/d66/class_ekf.html#a1840694d8d4a1e71d2847a02d0e14964">Ekf::checkHaglYawResetReq</a>()</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;{</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    <span class="comment">// We need to reset the yaw angle after climbing away from the ground to enable</span></div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    <span class="comment">// recovery from ground level magnetic interference.</span></div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a31b4bc6b95c1c741136a688ae8028c17">mag_aligned_in_flight</a>) {</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        <span class="comment">// Check if height has increased sufficiently to be away from ground magnetic anomalies</span></div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;        <span class="comment">// and request a yaw reset if not already requested.</span></div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        <span class="keyword">static</span> constexpr <span class="keywordtype">float</span> mag_anomalies_max_hagl = 1.5f;</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">bool</span> above_mag_anomalies = (<a class="code" href="../../dc/d66/class_ekf.html#ab41addaa5482d62667328c300db0d25f">getTerrainVPos</a>() - <a class="code" href="../../dc/d66/class_ekf.html#acd779b7801421d846f714072ee78bbd6">_state</a>.<a class="code" href="../../de/d11/structestimator_1_1state_sample.html#a0cba220966df5150bcffcc95d01ef11f">pos</a>(2)) &gt; mag_anomalies_max_hagl;</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;        <a class="code" href="../../dc/d66/class_ekf.html#af41b850db61f2ba2fa543fe3cb805d6f">_mag_yaw_reset_req</a> = <a class="code" href="../../dc/d66/class_ekf.html#af41b850db61f2ba2fa543fe3cb805d6f">_mag_yaw_reset_req</a> || above_mag_anomalies;</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    }</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;}</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div><div class="line"><a name="l00128"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#ab41addaa5482d62667328c300db0d25f">  128</a></span>&#160;<span class="keywordtype">float</span> <a class="code" href="../../dc/d66/class_ekf.html#ab41addaa5482d62667328c300db0d25f">Ekf::getTerrainVPos</a>()<span class="keyword"> const</span></div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dc/d66/class_ekf.html#aa4df90e91dd289376fb0935c9facd7e2">isTerrainEstimateValid</a>() ? <a class="code" href="../../dc/d66/class_ekf.html#a2b3ef7b330f70897b858b988ab7c4d3b">_terrain_vpos</a> : <a class="code" href="../../dc/d66/class_ekf.html#aa2c5a9b5968445e5432ddb150fcb18d2">_last_on_ground_posD</a>;</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;}</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div><div class="line"><a name="l00133"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#aa73a3299bd9b9975e268bca91b385aae">  133</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../dc/d66/class_ekf.html#aa73a3299bd9b9975e268bca91b385aae">Ekf::runOnGroundYawReset</a>()</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;{</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../dc/d66/class_ekf.html#af41b850db61f2ba2fa543fe3cb805d6f">_mag_yaw_reset_req</a> &amp;&amp; <a class="code" href="../../dc/d66/class_ekf.html#af18ef975c56278f900dac296d4c0c1a0">isYawResetAuthorized</a>()) {</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">bool</span> has_realigned_yaw = <a class="code" href="../../dc/d66/class_ekf.html#a5f256767a45b3d7c57f75edade49287c">canResetMagHeading</a>()</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;                           ? <a class="code" href="../../dc/d66/class_ekf.html#aabb8e6ed59b04c33697c3a5105825f98">resetMagHeading</a>(<a class="code" href="../../dc/d66/class_ekf.html#a51ee969f6d4e139a22a52ad9a7e653a0">_mag_lpf</a>.<a class="code" href="../../dc/d8f/class_alpha_filter.html#ab4d2a41daa2d7d1e6b2fa83d4047b26b">getState</a>())</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;                           : <span class="keyword">false</span>;</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;        <a class="code" href="../../dc/d66/class_ekf.html#af41b850db61f2ba2fa543fe3cb805d6f">_mag_yaw_reset_req</a> = !has_realigned_yaw;</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    }</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;}</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div><div class="line"><a name="l00144"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#af18ef975c56278f900dac296d4c0c1a0">  144</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="../../dc/d66/class_ekf.html#af18ef975c56278f900dac296d4c0c1a0">Ekf::isYawResetAuthorized</a>()<span class="keyword"> const</span></div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    <span class="keywordflow">return</span> !<a class="code" href="../../dc/d66/class_ekf.html#a05d15d380482d0bbd650dba29aeccb4e">_mag_use_inhibit</a>;</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;}</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;</div><div class="line"><a name="l00149"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#a5f256767a45b3d7c57f75edade49287c">  149</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="../../dc/d66/class_ekf.html#a5f256767a45b3d7c57f75edade49287c">Ekf::canResetMagHeading</a>()<span class="keyword"> const</span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    <span class="keywordflow">return</span> !<a class="code" href="../../dc/d66/class_ekf.html#a11ae2a99f3c1d016c51dc7521b0c6384">isStrongMagneticDisturbance</a>();</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;}</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;</div><div class="line"><a name="l00154"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#a3a5746a93bc89940139428190db96f38">  154</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../dc/d66/class_ekf.html#a3a5746a93bc89940139428190db96f38">Ekf::runInAirYawReset</a>()</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;{</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../dc/d66/class_ekf.html#af41b850db61f2ba2fa543fe3cb805d6f">_mag_yaw_reset_req</a> &amp;&amp; <a class="code" href="../../dc/d66/class_ekf.html#af18ef975c56278f900dac296d4c0c1a0">isYawResetAuthorized</a>()) {</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        <span class="keywordtype">bool</span> has_realigned_yaw = <span class="keyword">false</span>;</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../dc/d66/class_ekf.html#abe44b8d6843af7e2a6b78c059b5dba9a">canRealignYawUsingGps</a>()) { has_realigned_yaw = <a class="code" href="../../dc/d66/class_ekf.html#a7896e8c019d0df0a0725a5f463800044">realignYawGPS</a>(); }</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../dc/d66/class_ekf.html#a5f256767a45b3d7c57f75edade49287c">canResetMagHeading</a>()) { has_realigned_yaw = <a class="code" href="../../dc/d66/class_ekf.html#aabb8e6ed59b04c33697c3a5105825f98">resetMagHeading</a>(<a class="code" href="../../dc/d66/class_ekf.html#a51ee969f6d4e139a22a52ad9a7e653a0">_mag_lpf</a>.<a class="code" href="../../dc/d8f/class_alpha_filter.html#ab4d2a41daa2d7d1e6b2fa83d4047b26b">getState</a>()); }</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;        <a class="code" href="../../dc/d66/class_ekf.html#af41b850db61f2ba2fa543fe3cb805d6f">_mag_yaw_reset_req</a> = !has_realigned_yaw;</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        <a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a31b4bc6b95c1c741136a688ae8028c17">mag_aligned_in_flight</a> = has_realigned_yaw;</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    }</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;}</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;</div><div class="line"><a name="l00167"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#abe44b8d6843af7e2a6b78c059b5dba9a">  167</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="../../dc/d66/class_ekf.html#abe44b8d6843af7e2a6b78c059b5dba9a">Ekf::canRealignYawUsingGps</a>()<span class="keyword"> const</span></div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;<span class="keyword"></span>{ </div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a3cb04a00d642f0a76ab98173cb64e36a">fixed_wing</a>;</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;}</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;</div><div class="line"><a name="l00172"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#a921384ecaa7912d4803add15c8d1b2e8">  172</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../dc/d66/class_ekf.html#a921384ecaa7912d4803add15c8d1b2e8">Ekf::runVelPosReset</a>()</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;{</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../dc/d66/class_ekf.html#ad5c4866ae07c08e475a743f0d2755da1">_velpos_reset_request</a>) {</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        <a class="code" href="../../dc/d66/class_ekf.html#a0268d0e1335a60952fa8bb722f821674">resetVelocity</a>();</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;        <a class="code" href="../../dc/d66/class_ekf.html#a427d41afde8eb4acb8fc5290bcfbcb9a">resetPosition</a>();</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        <a class="code" href="../../dc/d66/class_ekf.html#ad5c4866ae07c08e475a743f0d2755da1">_velpos_reset_request</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    }</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;}</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;</div><div class="line"><a name="l00181"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#ae6bc4a65c6605547f3a7570d1060ff0f">  181</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../dc/d66/class_ekf.html#ae6bc4a65c6605547f3a7570d1060ff0f">Ekf::selectMagAuto</a>()</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;{</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    <a class="code" href="../../dc/d66/class_ekf.html#adedc1dc5e57f319a2b0d70452ea36238">check3DMagFusionSuitability</a>();</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    <a class="code" href="../../dc/d66/class_ekf.html#aed683ba8a5652b59c7a3df47bfeab4e7">canUse3DMagFusion</a>() ? <a class="code" href="../../dc/d66/class_ekf.html#a8722aaa3baa6b8fb1a837b9478f35105">startMag3DFusion</a>() : <a class="code" href="../../dc/d66/class_ekf.html#a0828d9e222ff448c3686d36d3eafbad3">startMagHdgFusion</a>();</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;}</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;</div><div class="line"><a name="l00187"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#adedc1dc5e57f319a2b0d70452ea36238">  187</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../dc/d66/class_ekf.html#adedc1dc5e57f319a2b0d70452ea36238">Ekf::check3DMagFusionSuitability</a>()</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;{</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    <a class="code" href="../../dc/d66/class_ekf.html#a668eac17be299fcd8995f28be4151266">checkYawAngleObservability</a>();</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    <a class="code" href="../../dc/d66/class_ekf.html#ac9be4a8a86dc2398d6b9a053ae8ac472">checkMagBiasObservability</a>();</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../dc/d66/class_ekf.html#a80f10caaa9a04cf28d0cd7b26159f067">isMagBiasObservable</a>() || <a class="code" href="../../dc/d66/class_ekf.html#a962d6be8242144203599b519d6376f52">isYawAngleObservable</a>()) {</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        <a class="code" href="../../dc/d66/class_ekf.html#a0d6b030d36693f1043b55f1a2ed21db9">_time_last_mov_3d_mag_suitable</a> = <a class="code" href="../../d5/d73/class_estimator_interface.html#acd1d3096fedb2e7fda208756eca6f4a5">_imu_sample_delayed</a>.<a class="code" href="../../d4/d03/structestimator_1_1imu_sample.html#ae09369e134378c8b1550bbfac630302b">time_us</a>;</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    }</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;}</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;</div><div class="line"><a name="l00197"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#a668eac17be299fcd8995f28be4151266">  197</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../dc/d66/class_ekf.html#a668eac17be299fcd8995f28be4151266">Ekf::checkYawAngleObservability</a>()</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;{</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    <span class="comment">// Check if there has been enough change in horizontal velocity to make yaw observable</span></div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    <span class="comment">// Apply hysteresis to check to avoid rapid toggling</span></div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    <a class="code" href="../../dc/d66/class_ekf.html#a17541c6b2f74ed5bac8d1f5a36d68ca0">_yaw_angle_observable</a> = <a class="code" href="../../dc/d66/class_ekf.html#a17541c6b2f74ed5bac8d1f5a36d68ca0">_yaw_angle_observable</a></div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;                ? <a class="code" href="../../dc/d66/class_ekf.html#afb41649747b69caedaa32d4c3d414342">_accel_lpf_NE</a>.norm() &gt; <a class="code" href="../../d5/d73/class_estimator_interface.html#ae214374497f6c641a8d9a350149ec4bf">_params</a>.<a class="code" href="../../d8/d25/structestimator_1_1parameters.html#af698d1d7ea62f23593ea482584b02138">mag_acc_gate</a></div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;                : <a class="code" href="../../dc/d66/class_ekf.html#afb41649747b69caedaa32d4c3d414342">_accel_lpf_NE</a>.norm() &gt; 2.0f * <a class="code" href="../../d5/d73/class_estimator_interface.html#ae214374497f6c641a8d9a350149ec4bf">_params</a>.<a class="code" href="../../d8/d25/structestimator_1_1parameters.html#af698d1d7ea62f23593ea482584b02138">mag_acc_gate</a>;</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    <a class="code" href="../../dc/d66/class_ekf.html#a17541c6b2f74ed5bac8d1f5a36d68ca0">_yaw_angle_observable</a> = <a class="code" href="../../dc/d66/class_ekf.html#a17541c6b2f74ed5bac8d1f5a36d68ca0">_yaw_angle_observable</a></div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;                &amp;&amp; (<a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a126c45278033233f82118e530dbca823">gps</a> || <a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#af440db5ab08e98b404bc0e820274d77e">ev_pos</a>); <span class="comment">// Do we have to add ev_vel here?</span></div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;}</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;</div><div class="line"><a name="l00209"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#ac9be4a8a86dc2398d6b9a053ae8ac472">  209</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../dc/d66/class_ekf.html#ac9be4a8a86dc2398d6b9a053ae8ac472">Ekf::checkMagBiasObservability</a>()</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;{</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    <span class="comment">// check if there is enough yaw rotation to make the mag bias states observable</span></div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../dc/d66/class_ekf.html#a4946eb7ab38bacee07201925350f1a29">_mag_bias_observable</a> &amp;&amp; (fabsf(<a class="code" href="../../dc/d66/class_ekf.html#a811d13238bb8d2fd5d1e669e443a55bc">_yaw_rate_lpf_ef</a>) &gt; <a class="code" href="../../d5/d73/class_estimator_interface.html#ae214374497f6c641a8d9a350149ec4bf">_params</a>.<a class="code" href="../../d8/d25/structestimator_1_1parameters.html#af9c040e5ae40dc13f8b163017564b822">mag_yaw_rate_gate</a>)) {</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;        <span class="comment">// initial yaw motion is detected</span></div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;        <a class="code" href="../../dc/d66/class_ekf.html#a4946eb7ab38bacee07201925350f1a29">_mag_bias_observable</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../dc/d66/class_ekf.html#a4946eb7ab38bacee07201925350f1a29">_mag_bias_observable</a>) {</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;        <span class="comment">// require sustained yaw motion of 50% the initial yaw rate threshold</span></div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">float</span> yaw_dt = 1e-6<a class="code" href="../../d8/da1/integration_8cpp.html#af5ba872dd09316732300733cc164ac1a">f</a> * (float)(<a class="code" href="../../d5/d73/class_estimator_interface.html#acd1d3096fedb2e7fda208756eca6f4a5">_imu_sample_delayed</a>.<a class="code" href="../../d4/d03/structestimator_1_1imu_sample.html#ae09369e134378c8b1550bbfac630302b">time_us</a> - <a class="code" href="../../dc/d66/class_ekf.html#a3d888a1e60fb15a61f723d6d49ef9b34">_time_yaw_started</a>);</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">float</span> min_yaw_change_req =  0.5f * <a class="code" href="../../d5/d73/class_estimator_interface.html#ae214374497f6c641a8d9a350149ec4bf">_params</a>.<a class="code" href="../../d8/d25/structestimator_1_1parameters.html#af9c040e5ae40dc13f8b163017564b822">mag_yaw_rate_gate</a> * yaw_dt;</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        <a class="code" href="../../dc/d66/class_ekf.html#a4946eb7ab38bacee07201925350f1a29">_mag_bias_observable</a> = fabsf(<a class="code" href="../../dc/d66/class_ekf.html#a2821776b166e78871ef9f7eac8838457">_yaw_delta_ef</a>) &gt; min_yaw_change_req;</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    }</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    <a class="code" href="../../dc/d66/class_ekf.html#a2821776b166e78871ef9f7eac8838457">_yaw_delta_ef</a> = 0.0f;</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <a class="code" href="../../dc/d66/class_ekf.html#a3d888a1e60fb15a61f723d6d49ef9b34">_time_yaw_started</a> = <a class="code" href="../../d5/d73/class_estimator_interface.html#acd1d3096fedb2e7fda208756eca6f4a5">_imu_sample_delayed</a>.<a class="code" href="../../d4/d03/structestimator_1_1imu_sample.html#ae09369e134378c8b1550bbfac630302b">time_us</a>;</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;}</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;</div><div class="line"><a name="l00227"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#a962d6be8242144203599b519d6376f52">  227</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="../../dc/d66/class_ekf.html#a962d6be8242144203599b519d6376f52">Ekf::isYawAngleObservable</a>()<span class="keyword"> const</span></div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dc/d66/class_ekf.html#a17541c6b2f74ed5bac8d1f5a36d68ca0">_yaw_angle_observable</a>;</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;}</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;</div><div class="line"><a name="l00232"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#a80f10caaa9a04cf28d0cd7b26159f067">  232</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="../../dc/d66/class_ekf.html#a80f10caaa9a04cf28d0cd7b26159f067">Ekf::isMagBiasObservable</a>()<span class="keyword"> const</span></div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dc/d66/class_ekf.html#a4946eb7ab38bacee07201925350f1a29">_mag_bias_observable</a>;</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;}</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;</div><div class="line"><a name="l00237"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#aed683ba8a5652b59c7a3df47bfeab4e7">  237</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="../../dc/d66/class_ekf.html#aed683ba8a5652b59c7a3df47bfeab4e7">Ekf::canUse3DMagFusion</a>()<span class="keyword"> const</span></div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    <span class="comment">// Use of 3D fusion requires an in-air heading alignment but it should not</span></div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    <span class="comment">// be used when the heading and mag biases are not observable for more than 2 seconds</span></div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a31b4bc6b95c1c741136a688ae8028c17">mag_aligned_in_flight</a></div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;           &amp;&amp; ((<a class="code" href="../../d5/d73/class_estimator_interface.html#acd1d3096fedb2e7fda208756eca6f4a5">_imu_sample_delayed</a>.<a class="code" href="../../d4/d03/structestimator_1_1imu_sample.html#ae09369e134378c8b1550bbfac630302b">time_us</a> - <a class="code" href="../../dc/d66/class_ekf.html#a0d6b030d36693f1043b55f1a2ed21db9">_time_last_mov_3d_mag_suitable</a>) &lt; (uint64_t)2e6);</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;}</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;</div><div class="line"><a name="l00245"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#a8f27dacb50fc38aaeca8170d88b75815">  245</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../dc/d66/class_ekf.html#a8f27dacb50fc38aaeca8170d88b75815">Ekf::checkMagDeclRequired</a>()</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;{</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    <span class="comment">// if we are using 3-axis magnetometer fusion, but without external NE aiding,</span></div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    <span class="comment">// then the declination must be fused as an observation to prevent long term heading drift</span></div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    <span class="comment">// fusing declination when gps aiding is available is optional, but recommended to prevent</span></div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    <span class="comment">// problem if the vehicle is static for extended periods of time</span></div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">bool</span> user_selected = (<a class="code" href="../../d5/d73/class_estimator_interface.html#ae214374497f6c641a8d9a350149ec4bf">_params</a>.<a class="code" href="../../d8/d25/structestimator_1_1parameters.html#a6dcde7409e3ffa26b6c014aac8802e73">mag_declination_source</a> &amp; <a class="code" href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h.html#a012d3efd061be28ed7a33be5892ac563">MASK_FUSE_DECL</a>);</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">bool</span> not_using_ne_aiding = !<a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a126c45278033233f82118e530dbca823">gps</a>;</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    <a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a4b27dd8c68c00ea5a309ececb01538a1">mag_dec</a> = (<a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a0ed4a03873a8549631f4f5cbb084132e">mag_3D</a> &amp;&amp; (not_using_ne_aiding || user_selected));</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;}</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;</div><div class="line"><a name="l00256"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#a02303e56b30d1704f2be3e0e8a04e095">  256</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../dc/d66/class_ekf.html#a02303e56b30d1704f2be3e0e8a04e095">Ekf::checkMagInhibition</a>()</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;{</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    <a class="code" href="../../dc/d66/class_ekf.html#a05d15d380482d0bbd650dba29aeccb4e">_mag_use_inhibit</a> = <a class="code" href="../../dc/d66/class_ekf.html#a9cd4984bf21090bc609aff6391edff08">shouldInhibitMag</a>();</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../dc/d66/class_ekf.html#a05d15d380482d0bbd650dba29aeccb4e">_mag_use_inhibit</a>) { </div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;        <a class="code" href="../../dc/d66/class_ekf.html#a9f954eb2ac15055a4932c47c25b71a93">_mag_use_not_inhibit_us</a> = <a class="code" href="../../d5/d73/class_estimator_interface.html#acd1d3096fedb2e7fda208756eca6f4a5">_imu_sample_delayed</a>.<a class="code" href="../../d4/d03/structestimator_1_1imu_sample.html#ae09369e134378c8b1550bbfac630302b">time_us</a>;</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;    }</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    <span class="comment">// If magnetometer use has been inhibited continuously then a yaw reset is required for a valid heading</span></div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="keywordflow">if</span> (uint32_t(<a class="code" href="../../d5/d73/class_estimator_interface.html#acd1d3096fedb2e7fda208756eca6f4a5">_imu_sample_delayed</a>.<a class="code" href="../../d4/d03/structestimator_1_1imu_sample.html#ae09369e134378c8b1550bbfac630302b">time_us</a> - <a class="code" href="../../dc/d66/class_ekf.html#a9f954eb2ac15055a4932c47c25b71a93">_mag_use_not_inhibit_us</a>) &gt; (uint32_t)5e6) {</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;        <a class="code" href="../../dc/d66/class_ekf.html#a296928902b9783f5f605ff5993cb7df5">_mag_inhibit_yaw_reset_req</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    }</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;}</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;</div><div class="line"><a name="l00269"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#a9cd4984bf21090bc609aff6391edff08">  269</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="../../dc/d66/class_ekf.html#a9cd4984bf21090bc609aff6391edff08">Ekf::shouldInhibitMag</a>()<span class="keyword"> const</span></div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    <span class="comment">// If the user has selected auto protection against indoor magnetic field errors, only use the magnetometer</span></div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    <span class="comment">// if a yaw angle relative to true North is required for navigation. If no GPS or other earth frame aiding</span></div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    <span class="comment">// is available, assume that we are operating indoors and the magnetometer should not be used.</span></div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    <span class="comment">// Also inhibit mag fusion when a strong magnetic field interference is detected</span></div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">bool</span> user_selected = (<a class="code" href="../../d5/d73/class_estimator_interface.html#ae214374497f6c641a8d9a350149ec4bf">_params</a>.<a class="code" href="../../d8/d25/structestimator_1_1parameters.html#a788a99a27570b5b2d842bb929b542962">mag_fusion_type</a> == <a class="code" href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h.html#a360271849b29e59bf99c44f4738ae968">MAG_FUSE_TYPE_INDOOR</a>);</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">bool</span> heading_not_required_for_navigation = !<a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a126c45278033233f82118e530dbca823">gps</a></div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;                             &amp;&amp; !<a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#af440db5ab08e98b404bc0e820274d77e">ev_pos</a></div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;                             &amp;&amp; !<a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a9a6ef5f7c0dc613df18820dd4940abe3">ev_vel</a>;</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    <span class="keywordflow">return</span> (user_selected &amp;&amp; heading_not_required_for_navigation)</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;           || <a class="code" href="../../dc/d66/class_ekf.html#a11ae2a99f3c1d016c51dc7521b0c6384">isStrongMagneticDisturbance</a>();</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;}</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;</div><div class="line"><a name="l00285"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#ab032c45aa539ecd512d7e539bbbf38fd">  285</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../dc/d66/class_ekf.html#ab032c45aa539ecd512d7e539bbbf38fd">Ekf::checkMagFieldStrength</a>()</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;{</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d5/d73/class_estimator_interface.html#ae214374497f6c641a8d9a350149ec4bf">_params</a>.<a class="code" href="../../d8/d25/structestimator_1_1parameters.html#aa6b15cffa0332cb41e7bd3fb460d74c0">check_mag_strength</a>) {</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        <a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#ac11b6dc405b4d79f6d2b1e6f6a667106">mag_field_disturbed</a> = <a class="code" href="../../d5/d73/class_estimator_interface.html#ae3ac54a69a49c702c274e67bfdb0f167">_NED_origin_initialised</a></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                                ? !<a class="code" href="../../dc/d66/class_ekf.html#a5363ceef7d620a5eef0e336ef5f9b749">isMeasuredMatchingGpsMagStrength</a>()</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                                : !<a class="code" href="../../dc/d66/class_ekf.html#a3d6387e362409f5306a3a7cfde7d7401">isMeasuredMatchingAverageMagStrength</a>();</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        <a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#ac11b6dc405b4d79f6d2b1e6f6a667106">mag_field_disturbed</a> = <span class="keyword">false</span>;</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    }</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;}</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;</div><div class="line"><a name="l00297"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#a11ae2a99f3c1d016c51dc7521b0c6384">  297</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="../../dc/d66/class_ekf.html#a11ae2a99f3c1d016c51dc7521b0c6384">Ekf::isStrongMagneticDisturbance</a>()<span class="keyword"> const</span></div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#ac11b6dc405b4d79f6d2b1e6f6a667106">mag_field_disturbed</a>;</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;}</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;</div><div class="line"><a name="l00302"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#a5363ceef7d620a5eef0e336ef5f9b749">  302</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="../../dc/d66/class_ekf.html#a5363ceef7d620a5eef0e336ef5f9b749">Ekf::isMeasuredMatchingGpsMagStrength</a>()<span class="keyword"> const</span></div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    constexpr <span class="keywordtype">float</span> wmm_gate_size = 0.2f; <span class="comment">// +/- Gauss</span></div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dc/d66/class_ekf.html#a6e7b668998c21ebc814242ce304f59a5">isMeasuredMatchingExpected</a>(<a class="code" href="../../d5/d73/class_estimator_interface.html#aebfe470fa3e331559248f516f03833e1">_mag_sample_delayed</a>.<a class="code" href="../../da/daf/structestimator_1_1mag_sample.html#a32cc19a6ee68ac84aa7b0b91c61800f4">mag</a>.length(), <a class="code" href="../../d5/d73/class_estimator_interface.html#ae173838ecc348cb7c9b4f8cc52e710b0">_mag_strength_gps</a>, wmm_gate_size);</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;}</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;</div><div class="line"><a name="l00308"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#a3d6387e362409f5306a3a7cfde7d7401">  308</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="../../dc/d66/class_ekf.html#a3d6387e362409f5306a3a7cfde7d7401">Ekf::isMeasuredMatchingAverageMagStrength</a>()<span class="keyword"> const</span></div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    constexpr <span class="keywordtype">float</span> average_earth_mag_field_strength = 0.45f; <span class="comment">// Gauss</span></div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    constexpr <span class="keywordtype">float</span> average_earth_mag_gate_size = 0.40f; <span class="comment">// +/- Gauss</span></div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../dc/d66/class_ekf.html#a6e7b668998c21ebc814242ce304f59a5">isMeasuredMatchingExpected</a>(<a class="code" href="../../d5/d73/class_estimator_interface.html#aebfe470fa3e331559248f516f03833e1">_mag_sample_delayed</a>.<a class="code" href="../../da/daf/structestimator_1_1mag_sample.html#a32cc19a6ee68ac84aa7b0b91c61800f4">mag</a>.length(),</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;                      average_earth_mag_field_strength,</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;                      average_earth_mag_gate_size);</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;}</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;</div><div class="line"><a name="l00317"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#a6e7b668998c21ebc814242ce304f59a5">  317</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="../../dc/d66/class_ekf.html#a6e7b668998c21ebc814242ce304f59a5">Ekf::isMeasuredMatchingExpected</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> measured, <span class="keyword">const</span> <span class="keywordtype">float</span> expected, <span class="keyword">const</span> <span class="keywordtype">float</span> gate)</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;{</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    <span class="keywordflow">return</span> (measured &gt;= expected - gate)</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;        &amp;&amp; (measured &lt;= expected + gate);</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;}</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;</div><div class="line"><a name="l00323"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#a434e228e673df0f462f033994eefb197">  323</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../dc/d66/class_ekf.html#a434e228e673df0f462f033994eefb197">Ekf::runMagAndMagDeclFusions</a>()</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;{</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a0ed4a03873a8549631f4f5cbb084132e">mag_3D</a>) {</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        <a class="code" href="../../dc/d66/class_ekf.html#a0d270537ecebeb4065a1b97e5e586e7f">run3DMagAndDeclFusions</a>();</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a85635129a9ed1626c1dc1552ef310a4a">mag_hdg</a>) {</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;        <a class="code" href="../../dc/d66/class_ekf.html#af644f0431ec8322a6e6bc2dfb7cdff3d">fuseHeading</a>();</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    }</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;}</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;</div><div class="line"><a name="l00333"></a><span class="lineno"><a class="line" href="../../dc/d66/class_ekf.html#a0d270537ecebeb4065a1b97e5e586e7f">  333</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../dc/d66/class_ekf.html#a0d270537ecebeb4065a1b97e5e586e7f">Ekf::run3DMagAndDeclFusions</a>()</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;{</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="../../dc/d66/class_ekf.html#adbe4e50f47ab3a25c2f465fc9b66b635">_mag_decl_cov_reset</a>) {</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;        <span class="comment">// After any magnetic field covariance reset event the earth field state</span></div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;        <span class="comment">// covariances need to be corrected to incorporate knowledge of the declination</span></div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;        <span class="comment">// before fusing magnetomer data to prevent rapid rotation of the earth field</span></div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;        <span class="comment">// states for the first few observations.</span></div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;        <a class="code" href="../../dc/d66/class_ekf.html#a6cab516f98e08b6356cf8903c3b4adfd">fuseDeclination</a>(0.02<a class="code" href="../../d8/da1/integration_8cpp.html#af5ba872dd09316732300733cc164ac1a">f</a>);</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;        <a class="code" href="../../dc/d66/class_ekf.html#adbe4e50f47ab3a25c2f465fc9b66b635">_mag_decl_cov_reset</a> = <span class="keyword">true</span>;</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;        <a class="code" href="../../dc/d66/class_ekf.html#a24f1225aaeec71df4d34d20777c1f528">fuseMag</a>();</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        <span class="comment">// The normal sequence is to fuse the magnetometer data first before fusing</span></div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        <span class="comment">// declination angle at a higher uncertainty to allow some learning of</span></div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;        <span class="comment">// declination angle over time.</span></div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        <a class="code" href="../../dc/d66/class_ekf.html#a24f1225aaeec71df4d34d20777c1f528">fuseMag</a>();</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">_control_status</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">flags</a>.<a class="code" href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a4b27dd8c68c00ea5a309ececb01538a1">mag_dec</a>) {</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;            <a class="code" href="../../dc/d66/class_ekf.html#a6cab516f98e08b6356cf8903c3b4adfd">fuseDeclination</a>(0.5<a class="code" href="../../d8/da1/integration_8cpp.html#af5ba872dd09316732300733cc164ac1a">f</a>);</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;        }</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    }</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;}</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;</div><div class="ttc" id="class_ekf_html_aed683ba8a5652b59c7a3df47bfeab4e7"><div class="ttname"><a href="../../dc/d66/class_ekf.html#aed683ba8a5652b59c7a3df47bfeab4e7">Ekf::canUse3DMagFusion</a></div><div class="ttdeci">bool canUse3DMagFusion() const</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00237">mag_control.cpp:237</a></div></div>
<div class="ttc" id="class_ekf_html_a6cab516f98e08b6356cf8903c3b4adfd"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a6cab516f98e08b6356cf8903c3b4adfd">Ekf::fuseDeclination</a></div><div class="ttdeci">void fuseDeclination(float decl_sigma)</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d21/mag__fusion_8cpp_source.html#l00815">mag_fusion.cpp:815</a></div></div>
<div class="ttc" id="unionestimator_1_1filter__control__status__u_html_aedd7d61443c30189df1746a1b1181089"><div class="ttname"><a href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aedd7d61443c30189df1746a1b1181089">estimator::filter_control_status_u::flags</a></div><div class="ttdeci">struct estimator::filter_control_status_u::@60 flags</div></div>
<div class="ttc" id="unionestimator_1_1filter__control__status__u_html_ab8678e0a92082eaddbd6569a76cba296"><div class="ttname"><a href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#ab8678e0a92082eaddbd6569a76cba296">estimator::filter_control_status_u::gps_yaw</a></div><div class="ttdeci">uint32_t gps_yaw</div><div class="ttdoc">22 - true when yaw (not ground course) data from a GPS receiver is being fused </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00463">common.h:463</a></div></div>
<div class="ttc" id="class_ekf_html_acd779b7801421d846f714072ee78bbd6"><div class="ttname"><a href="../../dc/d66/class_ekf.html#acd779b7801421d846f714072ee78bbd6">Ekf::_state</a></div><div class="ttdeci">stateSample _state</div><div class="ttdoc">state struct of the ekf running at the delayed time horizon </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d14/ekf_8h_source.html#l00288">ekf.h:288</a></div></div>
<div class="ttc" id="class_ekf_html_a0d6b030d36693f1043b55f1a2ed21db9"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a0d6b030d36693f1043b55f1a2ed21db9">Ekf::_time_last_mov_3d_mag_suitable</a></div><div class="ttdeci">uint64_t _time_last_mov_3d_mag_suitable</div><div class="ttdoc">last system time that sufficient movement to use 3-axis magnetometer fusion was detected (uSec) ...</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d14/ekf_8h_source.html#l00442">ekf.h:442</a></div></div>
<div class="ttc" id="unionestimator_1_1filter__control__status__u_html_a15f198a7368ad17fad86d5e839444197"><div class="ttname"><a href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a15f198a7368ad17fad86d5e839444197">estimator::filter_control_status_u::yaw_align</a></div><div class="ttdeci">uint32_t yaw_align</div><div class="ttdoc">1 - true if the filter yaw alignment is complete </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00442">common.h:442</a></div></div>
<div class="ttc" id="class_ekf_html_a811d13238bb8d2fd5d1e669e443a55bc"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a811d13238bb8d2fd5d1e669e443a55bc">Ekf::_yaw_rate_lpf_ef</a></div><div class="ttdeci">float _yaw_rate_lpf_ef</div><div class="ttdoc">Filtered angular rate about earth frame D axis (rad/sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d14/ekf_8h_source.html#l00353">ekf.h:353</a></div></div>
<div class="ttc" id="class_ekf_html_aabb8e6ed59b04c33697c3a5105825f98"><div class="ttname"><a href="../../dc/d66/class_ekf.html#aabb8e6ed59b04c33697c3a5105825f98">Ekf::resetMagHeading</a></div><div class="ttdeci">bool resetMagHeading(const Vector3f &amp;mag_init, bool increase_yaw_var=true, bool update_buffer=true)</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d5c/ekf__helper_8cpp_source.html#l00554">ekf_helper.cpp:554</a></div></div>
<div class="ttc" id="class_ekf_html_ac9be4a8a86dc2398d6b9a053ae8ac472"><div class="ttname"><a href="../../dc/d66/class_ekf.html#ac9be4a8a86dc2398d6b9a053ae8ac472">Ekf::checkMagBiasObservability</a></div><div class="ttdeci">void checkMagBiasObservability()</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00209">mag_control.cpp:209</a></div></div>
<div class="ttc" id="lib_2ecl_2_e_k_f_2common_8h_html_a2f1eb3709f6c848456fb6cde11c5367c"><div class="ttname"><a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h.html#a2f1eb3709f6c848456fb6cde11c5367c">MAG_FUSE_TYPE_3D</a></div><div class="ttdeci">#define MAG_FUSE_TYPE_3D</div><div class="ttdoc">Magnetometer 3-axis fusion will always be used. This is more accurate, but more affected by localised...</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00202">common.h:202</a></div></div>
<div class="ttc" id="class_ekf_html_aa73a3299bd9b9975e268bca91b385aae"><div class="ttname"><a href="../../dc/d66/class_ekf.html#aa73a3299bd9b9975e268bca91b385aae">Ekf::runOnGroundYawReset</a></div><div class="ttdeci">void runOnGroundYawReset()</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00133">mag_control.cpp:133</a></div></div>
<div class="ttc" id="class_ekf_html_a9cd4984bf21090bc609aff6391edff08"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a9cd4984bf21090bc609aff6391edff08">Ekf::shouldInhibitMag</a></div><div class="ttdeci">bool shouldInhibitMag() const</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00269">mag_control.cpp:269</a></div></div>
<div class="ttc" id="class_ekf_html_af41b850db61f2ba2fa543fe3cb805d6f"><div class="ttname"><a href="../../dc/d66/class_ekf.html#af41b850db61f2ba2fa543fe3cb805d6f">Ekf::_mag_yaw_reset_req</a></div><div class="ttdeci">bool _mag_yaw_reset_req</div><div class="ttdoc">true when a reset of the yaw using the magnetometer data has been requested </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d14/ekf_8h_source.html#l00363">ekf.h:363</a></div></div>
<div class="ttc" id="class_ekf_html_a2821776b166e78871ef9f7eac8838457"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a2821776b166e78871ef9f7eac8838457">Ekf::_yaw_delta_ef</a></div><div class="ttdeci">float _yaw_delta_ef</div><div class="ttdoc">Recent change in yaw angle measured about the earth frame D axis (rad) </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d14/ekf_8h_source.html#l00352">ekf.h:352</a></div></div>
<div class="ttc" id="unionestimator_1_1filter__control__status__u_html_a3cb04a00d642f0a76ab98173cb64e36a"><div class="ttname"><a href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a3cb04a00d642f0a76ab98173cb64e36a">estimator::filter_control_status_u::fixed_wing</a></div><div class="ttdeci">uint32_t fixed_wing</div><div class="ttdoc">17 - true when the vehicle is operating as a fixed wing vehicle </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00458">common.h:458</a></div></div>
<div class="ttc" id="class_ekf_html_a0268d0e1335a60952fa8bb722f821674"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a0268d0e1335a60952fa8bb722f821674">Ekf::resetVelocity</a></div><div class="ttdeci">bool resetVelocity()</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d5c/ekf__helper_8cpp_source.html#l00050">ekf_helper.cpp:50</a></div></div>
<div class="ttc" id="unionestimator_1_1filter__control__status__u_html_a85635129a9ed1626c1dc1552ef310a4a"><div class="ttname"><a href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a85635129a9ed1626c1dc1552ef310a4a">estimator::filter_control_status_u::mag_hdg</a></div><div class="ttdeci">uint32_t mag_hdg</div><div class="ttdoc">4 - true if a simple magnetic yaw heading is being fused </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00445">common.h:445</a></div></div>
<div class="ttc" id="class_ekf_html_ae6bc4a65c6605547f3a7570d1060ff0f"><div class="ttname"><a href="../../dc/d66/class_ekf.html#ae6bc4a65c6605547f3a7570d1060ff0f">Ekf::selectMagAuto</a></div><div class="ttdeci">void selectMagAuto()</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00181">mag_control.cpp:181</a></div></div>
<div class="ttc" id="class_ekf_html_a921384ecaa7912d4803add15c8d1b2e8"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a921384ecaa7912d4803add15c8d1b2e8">Ekf::runVelPosReset</a></div><div class="ttdeci">void runVelPosReset()</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00172">mag_control.cpp:172</a></div></div>
<div class="ttc" id="class_ekf_html_afb41649747b69caedaa32d4c3d414342"><div class="ttname"><a href="../../dc/d66/class_ekf.html#afb41649747b69caedaa32d4c3d414342">Ekf::_accel_lpf_NE</a></div><div class="ttdeci">Vector2f _accel_lpf_NE</div><div class="ttdoc">Low pass filtered horizontal earth frame acceleration (m/sec**2) </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d14/ekf_8h_source.html#l00351">ekf.h:351</a></div></div>
<div class="ttc" id="class_ekf_html_a4fb97af3133b0f90b205c85424dca180"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a4fb97af3133b0f90b205c85424dca180">Ekf::canRunMagFusion</a></div><div class="ttdeci">bool canRunMagFusion() const</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00108">mag_control.cpp:108</a></div></div>
<div class="ttc" id="unionestimator_1_1filter__control__status__u_html_aab89779a504dd3856b9c81d5d04cf050"><div class="ttname"><a href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#aab89779a504dd3856b9c81d5d04cf050">estimator::filter_control_status_u::mag_fault</a></div><div class="ttdeci">uint32_t mag_fault</div><div class="ttdoc">18 - true when the magnetometer has been declared faulty and is no longer being used ...</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00459">common.h:459</a></div></div>
<div class="ttc" id="lib_2ecl_2_e_k_f_2common_8h_html_a692da991196dd22f9d80bdc05aa156c2"><div class="ttname"><a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h.html#a692da991196dd22f9d80bdc05aa156c2">MAG_FUSE_TYPE_HEADING</a></div><div class="ttdeci">#define MAG_FUSE_TYPE_HEADING</div><div class="ttdoc">Simple yaw angle fusion will always be used. This is less accurate, but less affected by earth field ...</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00201">common.h:201</a></div></div>
<div class="ttc" id="unionestimator_1_1filter__control__status__u_html_ac11b6dc405b4d79f6d2b1e6f6a667106"><div class="ttname"><a href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#ac11b6dc405b4d79f6d2b1e6f6a667106">estimator::filter_control_status_u::mag_field_disturbed</a></div><div class="ttdeci">uint32_t mag_field_disturbed</div><div class="ttdoc">16 - true when the mag field does not match the expected strength </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00457">common.h:457</a></div></div>
<div class="ttc" id="class_ekf_html_adbe4e50f47ab3a25c2f465fc9b66b635"><div class="ttname"><a href="../../dc/d66/class_ekf.html#adbe4e50f47ab3a25c2f465fc9b66b635">Ekf::_mag_decl_cov_reset</a></div><div class="ttdeci">bool _mag_decl_cov_reset</div><div class="ttdoc">true after the fuseDeclination() function has been used to modify the earth field covariances after a...</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d14/ekf_8h_source.html#l00364">ekf.h:364</a></div></div>
<div class="ttc" id="lib_2ecl_2_e_k_f_2common_8h_html_a360271849b29e59bf99c44f4738ae968"><div class="ttname"><a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h.html#a360271849b29e59bf99c44f4738ae968">MAG_FUSE_TYPE_INDOOR</a></div><div class="ttdeci">#define MAG_FUSE_TYPE_INDOOR</div><div class="ttdoc">The same as option 0, but magnetometer or yaw fusion will not be used unless earth frame external aid...</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00204">common.h:204</a></div></div>
<div class="ttc" id="class_ekf_html_a6e7b668998c21ebc814242ce304f59a5"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a6e7b668998c21ebc814242ce304f59a5">Ekf::isMeasuredMatchingExpected</a></div><div class="ttdeci">static bool isMeasuredMatchingExpected(float measured, float expected, float gate)</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00317">mag_control.cpp:317</a></div></div>
<div class="ttc" id="class_ekf_html_a296928902b9783f5f605ff5993cb7df5"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a296928902b9783f5f605ff5993cb7df5">Ekf::_mag_inhibit_yaw_reset_req</a></div><div class="ttdeci">bool _mag_inhibit_yaw_reset_req</div><div class="ttdoc">true when magnetometer inhibit has been active for long enough to require a yaw reset when conditions...</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d14/ekf_8h_source.html#l00361">ekf.h:361</a></div></div>
<div class="ttc" id="class_alpha_filter_html_ab4d2a41daa2d7d1e6b2fa83d4047b26b"><div class="ttname"><a href="../../dc/d8f/class_alpha_filter.html#ab4d2a41daa2d7d1e6b2fa83d4047b26b">AlphaFilter::getState</a></div><div class="ttdeci">const T &amp; getState() const</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d85/_alpha_filter_8hpp_source.html#l00067">AlphaFilter.hpp:67</a></div></div>
<div class="ttc" id="class_ekf_html_ab032c45aa539ecd512d7e539bbbf38fd"><div class="ttname"><a href="../../dc/d66/class_ekf.html#ab032c45aa539ecd512d7e539bbbf38fd">Ekf::checkMagFieldStrength</a></div><div class="ttdeci">void checkMagFieldStrength()</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00285">mag_control.cpp:285</a></div></div>
<div class="ttc" id="class_ekf_html_a2b3ef7b330f70897b858b988ab7c4d3b"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a2b3ef7b330f70897b858b988ab7c4d3b">Ekf::_terrain_vpos</a></div><div class="ttdeci">float _terrain_vpos</div><div class="ttdoc">estimated vertical position of the terrain underneath the vehicle in local NED frame (m) ...</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d14/ekf_8h_source.html#l00457">ekf.h:457</a></div></div>
<div class="ttc" id="class_estimator_interface_html_ae3ac54a69a49c702c274e67bfdb0f167"><div class="ttname"><a href="../../d5/d73/class_estimator_interface.html#ae3ac54a69a49c702c274e67bfdb0f167">EstimatorInterface::_NED_origin_initialised</a></div><div class="ttdeci">bool _NED_origin_initialised</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d77/estimator__interface_8h_source.html#l00477">estimator_interface.h:477</a></div></div>
<div class="ttc" id="class_ekf_html_a51ee969f6d4e139a22a52ad9a7e653a0"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a51ee969f6d4e139a22a52ad9a7e653a0">Ekf::_mag_lpf</a></div><div class="ttdeci">AlphaFilterVector3f _mag_lpf</div><div class="ttdoc">filtered magnetometer measurement (Gauss) </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d14/ekf_8h_source.html#l00433">ekf.h:433</a></div></div>
<div class="ttc" id="class_ekf_html_a11ae2a99f3c1d016c51dc7521b0c6384"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a11ae2a99f3c1d016c51dc7521b0c6384">Ekf::isStrongMagneticDisturbance</a></div><div class="ttdeci">bool isStrongMagneticDisturbance() const</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00297">mag_control.cpp:297</a></div></div>
<div class="ttc" id="unionestimator_1_1filter__control__status__u_html_a9a6ef5f7c0dc613df18820dd4940abe3"><div class="ttname"><a href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a9a6ef5f7c0dc613df18820dd4940abe3">estimator::filter_control_status_u::ev_vel</a></div><div class="ttdeci">uint32_t ev_vel</div><div class="ttdoc">24 - true when local earth frame velocity data from external vision measurements are being fused ...</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00465">common.h:465</a></div></div>
<div class="ttc" id="class_ekf_html_a434e228e673df0f462f033994eefb197"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a434e228e673df0f462f033994eefb197">Ekf::runMagAndMagDeclFusions</a></div><div class="ttdeci">void runMagAndMagDeclFusions()</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00323">mag_control.cpp:323</a></div></div>
<div class="ttc" id="class_ekf_html_a0ca03003996218259d343d526f065ae3"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a0ca03003996218259d343d526f065ae3">Ekf::updateMagFilter</a></div><div class="ttdeci">void updateMagFilter()</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00101">mag_control.cpp:101</a></div></div>
<div class="ttc" id="structestimator_1_1parameters_html_a6dcde7409e3ffa26b6c014aac8802e73"><div class="ttname"><a href="../../d8/d25/structestimator_1_1parameters.html#a6dcde7409e3ffa26b6c014aac8802e73">estimator::parameters::mag_declination_source</a></div><div class="ttdeci">int32_t mag_declination_source</div><div class="ttdoc">bitmask used to control the handling of declination data </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00274">common.h:274</a></div></div>
<div class="ttc" id="class_ekf_html_a7896e8c019d0df0a0725a5f463800044"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a7896e8c019d0df0a0725a5f463800044">Ekf::realignYawGPS</a></div><div class="ttdeci">bool realignYawGPS()</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d5c/ekf__helper_8cpp_source.html#l00405">ekf_helper.cpp:405</a></div></div>
<div class="ttc" id="class_ekf_html_af18ef975c56278f900dac296d4c0c1a0"><div class="ttname"><a href="../../dc/d66/class_ekf.html#af18ef975c56278f900dac296d4c0c1a0">Ekf::isYawResetAuthorized</a></div><div class="ttdeci">bool isYawResetAuthorized() const</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00144">mag_control.cpp:144</a></div></div>
<div class="ttc" id="class_ekf_html_a5363ceef7d620a5eef0e336ef5f9b749"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a5363ceef7d620a5eef0e336ef5f9b749">Ekf::isMeasuredMatchingGpsMagStrength</a></div><div class="ttdeci">bool isMeasuredMatchingGpsMagStrength() const</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00302">mag_control.cpp:302</a></div></div>
<div class="ttc" id="class_ekf_html_a5f256767a45b3d7c57f75edade49287c"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a5f256767a45b3d7c57f75edade49287c">Ekf::canResetMagHeading</a></div><div class="ttdeci">bool canResetMagHeading() const</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00149">mag_control.cpp:149</a></div></div>
<div class="ttc" id="class_ekf_html_ab41addaa5482d62667328c300db0d25f"><div class="ttname"><a href="../../dc/d66/class_ekf.html#ab41addaa5482d62667328c300db0d25f">Ekf::getTerrainVPos</a></div><div class="ttdeci">float getTerrainVPos() const</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00128">mag_control.cpp:128</a></div></div>
<div class="ttc" id="structestimator_1_1imu_sample_html_ae09369e134378c8b1550bbfac630302b"><div class="ttname"><a href="../../d4/d03/structestimator_1_1imu_sample.html#ae09369e134378c8b1550bbfac630302b">estimator::imuSample::time_us</a></div><div class="ttdeci">uint64_t time_us</div><div class="ttdoc">timestamp of the measurement (uSec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00111">common.h:111</a></div></div>
<div class="ttc" id="integration_8cpp_html_af5ba872dd09316732300733cc164ac1a"><div class="ttname"><a href="../../d8/da1/integration_8cpp.html#af5ba872dd09316732300733cc164ac1a">f</a></div><div class="ttdeci">Vector&lt; float, 6 &gt; f(float t, const Matrix&lt; float, 6, 1 &gt; &amp;, const Matrix&lt; float, 3, 1 &gt; &amp;)</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/da1/integration_8cpp_source.html#l00008">integration.cpp:8</a></div></div>
<div class="ttc" id="class_alpha_filter_html_a3e555d33f331f59097fb251f80bc8465"><div class="ttname"><a href="../../dc/d8f/class_alpha_filter.html#a3e555d33f331f59097fb251f80bc8465">AlphaFilter::update</a></div><div class="ttdeci">void update(const T &amp;input, float tau, float dt)</div><div class="ttdef"><b>Definition:</b> <a href="../../db/d85/_alpha_filter_8hpp_source.html#l00050">AlphaFilter.hpp:50</a></div></div>
<div class="ttc" id="class_estimator_interface_html_a24bb0c8f59912c789fc7e3322b1b4345"><div class="ttname"><a href="../../d5/d73/class_estimator_interface.html#a24bb0c8f59912c789fc7e3322b1b4345">EstimatorInterface::_control_status</a></div><div class="ttdeci">filter_control_status_u _control_status</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d77/estimator__interface_8h_source.html#l00564">estimator_interface.h:564</a></div></div>
<div class="ttc" id="structestimator_1_1parameters_html_af698d1d7ea62f23593ea482584b02138"><div class="ttname"><a href="../../d8/d25/structestimator_1_1parameters.html#af698d1d7ea62f23593ea482584b02138">estimator::parameters::mag_acc_gate</a></div><div class="ttdeci">float mag_acc_gate</div><div class="ttdoc">when in auto select mode, heading fusion will be used when manoeuvre accel is lower than this (m/sec*...</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00276">common.h:276</a></div></div>
<div class="ttc" id="class_ekf_html_a02303e56b30d1704f2be3e0e8a04e095"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a02303e56b30d1704f2be3e0e8a04e095">Ekf::checkMagInhibition</a></div><div class="ttdeci">void checkMagInhibition()</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00256">mag_control.cpp:256</a></div></div>
<div class="ttc" id="structestimator_1_1parameters_html_a788a99a27570b5b2d842bb929b542962"><div class="ttname"><a href="../../d8/d25/structestimator_1_1parameters.html#a788a99a27570b5b2d842bb929b542962">estimator::parameters::mag_fusion_type</a></div><div class="ttdeci">int32_t mag_fusion_type</div><div class="ttdoc">integer used to specify the type of magnetometer fusion used </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00275">common.h:275</a></div></div>
<div class="ttc" id="class_ekf_html_af7b13c3328aee801c57df71e99b3d2a2"><div class="ttname"><a href="../../dc/d66/class_ekf.html#af7b13c3328aee801c57df71e99b3d2a2">Ekf::controlMagFusion</a></div><div class="ttdeci">void controlMagFusion()</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00042">mag_control.cpp:42</a></div></div>
<div class="ttc" id="unionestimator_1_1filter__control__status__u_html_ab43159862f360179a62284dd2da03611"><div class="ttname"><a href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#ab43159862f360179a62284dd2da03611">estimator::filter_control_status_u::ev_yaw</a></div><div class="ttdeci">uint32_t ev_yaw</div><div class="ttdoc">13 - true when yaw data from external vision measurements is being fused </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00454">common.h:454</a></div></div>
<div class="ttc" id="class_ekf_html_ad5c4866ae07c08e475a743f0d2755da1"><div class="ttname"><a href="../../dc/d66/class_ekf.html#ad5c4866ae07c08e475a743f0d2755da1">Ekf::_velpos_reset_request</a></div><div class="ttdeci">bool _velpos_reset_request</div><div class="ttdoc">true when a large yaw error has been fixed and a velocity and position state reset is required ...</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d14/ekf_8h_source.html#l00445">ekf.h:445</a></div></div>
<div class="ttc" id="class_estimator_interface_html_ae173838ecc348cb7c9b4f8cc52e710b0"><div class="ttname"><a href="../../d5/d73/class_estimator_interface.html#ae173838ecc348cb7c9b4f8cc52e710b0">EstimatorInterface::_mag_strength_gps</a></div><div class="ttdeci">float _mag_strength_gps</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d77/estimator__interface_8h_source.html#l00561">estimator_interface.h:561</a></div></div>
<div class="ttc" id="class_ekf_html_abe44b8d6843af7e2a6b78c059b5dba9a"><div class="ttname"><a href="../../dc/d66/class_ekf.html#abe44b8d6843af7e2a6b78c059b5dba9a">Ekf::canRealignYawUsingGps</a></div><div class="ttdeci">bool canRealignYawUsingGps() const</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00167">mag_control.cpp:167</a></div></div>
<div class="ttc" id="unionestimator_1_1filter__control__status__u_html_a31b4bc6b95c1c741136a688ae8028c17"><div class="ttname"><a href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a31b4bc6b95c1c741136a688ae8028c17">estimator::filter_control_status_u::mag_aligned_in_flight</a></div><div class="ttdeci">uint32_t mag_aligned_in_flight</div><div class="ttdoc">23 - true when the in-flight mag field alignment has been completed </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00464">common.h:464</a></div></div>
<div class="ttc" id="class_estimator_interface_html_acd1d3096fedb2e7fda208756eca6f4a5"><div class="ttname"><a href="../../d5/d73/class_estimator_interface.html#acd1d3096fedb2e7fda208756eca6f4a5">EstimatorInterface::_imu_sample_delayed</a></div><div class="ttdeci">imuSample _imu_sample_delayed</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d77/estimator__interface_8h_source.html#l00438">estimator_interface.h:438</a></div></div>
<div class="ttc" id="class_ekf_html_a8f27dacb50fc38aaeca8170d88b75815"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a8f27dacb50fc38aaeca8170d88b75815">Ekf::checkMagDeclRequired</a></div><div class="ttdeci">void checkMagDeclRequired()</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00245">mag_control.cpp:245</a></div></div>
<div class="ttc" id="class_ekf_html_a24f1225aaeec71df4d34d20777c1f528"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a24f1225aaeec71df4d34d20777c1f528">Ekf::fuseMag</a></div><div class="ttdeci">void fuseMag()</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d21/mag__fusion_8cpp_source.html#l00047">mag_fusion.cpp:47</a></div></div>
<div class="ttc" id="structestimator_1_1state_sample_html_a0cba220966df5150bcffcc95d01ef11f"><div class="ttname"><a href="../../de/d11/structestimator_1_1state_sample.html#a0cba220966df5150bcffcc95d01ef11f">estimator::stateSample::pos</a></div><div class="ttdeci">Vector3f pos</div><div class="ttdoc">NED position in earth frame in m. </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00370">common.h:370</a></div></div>
<div class="ttc" id="structestimator_1_1parameters_html_aa6b15cffa0332cb41e7bd3fb460d74c0"><div class="ttname"><a href="../../d8/d25/structestimator_1_1parameters.html#aa6b15cffa0332cb41e7bd3fb460d74c0">estimator::parameters::check_mag_strength</a></div><div class="ttdeci">int32_t check_mag_strength</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00364">common.h:364</a></div></div>
<div class="ttc" id="class_ekf_html_a05d15d380482d0bbd650dba29aeccb4e"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a05d15d380482d0bbd650dba29aeccb4e">Ekf::_mag_use_inhibit</a></div><div class="ttdeci">bool _mag_use_inhibit</div><div class="ttdoc">true when magnetometer use is being inhibited </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d14/ekf_8h_source.html#l00359">ekf.h:359</a></div></div>
<div class="ttc" id="unionestimator_1_1filter__control__status__u_html_a4b27dd8c68c00ea5a309ececb01538a1"><div class="ttname"><a href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a4b27dd8c68c00ea5a309ececb01538a1">estimator::filter_control_status_u::mag_dec</a></div><div class="ttdeci">uint32_t mag_dec</div><div class="ttdoc">6 - true if synthetic magnetic declination measurements are being fused </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00447">common.h:447</a></div></div>
<div class="ttc" id="lib_2ecl_2_e_k_f_2common_8h_html_a62073e26031e8cb0c5e120bf1dda7a92"><div class="ttname"><a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h.html#a62073e26031e8cb0c5e120bf1dda7a92">MAG_FUSE_TYPE_NONE</a></div><div class="ttdeci">#define MAG_FUSE_TYPE_NONE</div><div class="ttdoc">Do not use magnetometer under any circumstance. Other sources of yaw may be used if selected via the ...</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00205">common.h:205</a></div></div>
<div class="ttc" id="class_ekf_html_a3d888a1e60fb15a61f723d6d49ef9b34"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a3d888a1e60fb15a61f723d6d49ef9b34">Ekf::_time_yaw_started</a></div><div class="ttdeci">uint64_t _time_yaw_started</div><div class="ttdoc">last system time in usec that a yaw rotation manoeuvre was detected </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d14/ekf_8h_source.html#l00356">ekf.h:356</a></div></div>
<div class="ttc" id="unionestimator_1_1filter__control__status__u_html_a0ed4a03873a8549631f4f5cbb084132e"><div class="ttname"><a href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a0ed4a03873a8549631f4f5cbb084132e">estimator::filter_control_status_u::mag_3D</a></div><div class="ttdeci">uint32_t mag_3D</div><div class="ttdoc">5 - true if 3-axis magnetometer measurement are being fused </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00446">common.h:446</a></div></div>
<div class="ttc" id="unionestimator_1_1filter__control__status__u_html_a378bf598d2aaab4580c5bfb6567022a8"><div class="ttname"><a href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a378bf598d2aaab4580c5bfb6567022a8">estimator::filter_control_status_u::in_air</a></div><div class="ttdeci">uint32_t in_air</div><div class="ttdoc">7 - true when the vehicle is airborne </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00448">common.h:448</a></div></div>
<div class="ttc" id="class_ekf_html_a962d6be8242144203599b519d6376f52"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a962d6be8242144203599b519d6376f52">Ekf::isYawAngleObservable</a></div><div class="ttdeci">bool isYawAngleObservable() const</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00227">mag_control.cpp:227</a></div></div>
<div class="ttc" id="class_ekf_html_a17541c6b2f74ed5bac8d1f5a36d68ca0"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a17541c6b2f74ed5bac8d1f5a36d68ca0">Ekf::_yaw_angle_observable</a></div><div class="ttdeci">bool _yaw_angle_observable</div><div class="ttdoc">true when there is enough horizontal acceleration to make yaw observable </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d14/ekf_8h_source.html#l00355">ekf.h:355</a></div></div>
<div class="ttc" id="class_ekf_html_a8722aaa3baa6b8fb1a837b9478f35105"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a8722aaa3baa6b8fb1a837b9478f35105">Ekf::startMag3DFusion</a></div><div class="ttdeci">void startMag3DFusion()</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d5c/ekf__helper_8cpp_source.html#l01608">ekf_helper.cpp:1608</a></div></div>
<div class="ttc" id="class_ekf_html_a0d270537ecebeb4065a1b97e5e586e7f"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a0d270537ecebeb4065a1b97e5e586e7f">Ekf::run3DMagAndDeclFusions</a></div><div class="ttdeci">void run3DMagAndDeclFusions()</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00333">mag_control.cpp:333</a></div></div>
<div class="ttc" id="structestimator_1_1parameters_html_af9c040e5ae40dc13f8b163017564b822"><div class="ttname"><a href="../../d8/d25/structestimator_1_1parameters.html#af9c040e5ae40dc13f8b163017564b822">estimator::parameters::mag_yaw_rate_gate</a></div><div class="ttdeci">float mag_yaw_rate_gate</div><div class="ttdoc">yaw rate threshold used by mode select logic (rad/sec) </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00277">common.h:277</a></div></div>
<div class="ttc" id="unionestimator_1_1filter__control__status__u_html_af440db5ab08e98b404bc0e820274d77e"><div class="ttname"><a href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#af440db5ab08e98b404bc0e820274d77e">estimator::filter_control_status_u::ev_pos</a></div><div class="ttdeci">uint32_t ev_pos</div><div class="ttdoc">12 - true when local position data from external vision is being fused </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00453">common.h:453</a></div></div>
<div class="ttc" id="class_ekf_html_aa2c5a9b5968445e5432ddb150fcb18d2"><div class="ttname"><a href="../../dc/d66/class_ekf.html#aa2c5a9b5968445e5432ddb150fcb18d2">Ekf::_last_on_ground_posD</a></div><div class="ttdeci">float _last_on_ground_posD</div><div class="ttdoc">last vertical position when the in_air status was false (m) </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d14/ekf_8h_source.html#l00439">ekf.h:439</a></div></div>
<div class="ttc" id="class_ekf_html_a1840694d8d4a1e71d2847a02d0e14964"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a1840694d8d4a1e71d2847a02d0e14964">Ekf::checkHaglYawResetReq</a></div><div class="ttdeci">void checkHaglYawResetReq()</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00115">mag_control.cpp:115</a></div></div>
<div class="ttc" id="class_estimator_interface_html_ae214374497f6c641a8d9a350149ec4bf"><div class="ttname"><a href="../../d5/d73/class_estimator_interface.html#ae214374497f6c641a8d9a350149ec4bf">EstimatorInterface::_params</a></div><div class="ttdeci">parameters _params</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d77/estimator__interface_8h_source.html#l00415">estimator_interface.h:415</a></div></div>
<div class="ttc" id="class_ekf_html_a82bb548da63d49e7f01339c717297695"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a82bb548da63d49e7f01339c717297695">Ekf::_num_bad_flight_yaw_events</a></div><div class="ttdeci">uint8_t _num_bad_flight_yaw_events</div><div class="ttdoc">number of times a bad heading has been detected in flight and required a yaw reset ...</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d14/ekf_8h_source.html#l00357">ekf.h:357</a></div></div>
<div class="ttc" id="class_ekf_html_a3a5746a93bc89940139428190db96f38"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a3a5746a93bc89940139428190db96f38">Ekf::runInAirYawReset</a></div><div class="ttdeci">void runInAirYawReset()</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00154">mag_control.cpp:154</a></div></div>
<div class="ttc" id="class_ekf_html_af644f0431ec8322a6e6bc2dfb7cdff3d"><div class="ttname"><a href="../../dc/d66/class_ekf.html#af644f0431ec8322a6e6bc2dfb7cdff3d">Ekf::fuseHeading</a></div><div class="ttdeci">void fuseHeading()</div><div class="ttdef"><b>Definition:</b> <a href="../../d7/d21/mag__fusion_8cpp_source.html#l00438">mag_fusion.cpp:438</a></div></div>
<div class="ttc" id="unionestimator_1_1filter__control__status__u_html_a126c45278033233f82118e530dbca823"><div class="ttname"><a href="../../d2/d8b/unionestimator_1_1filter__control__status__u.html#a126c45278033233f82118e530dbca823">estimator::filter_control_status_u::gps</a></div><div class="ttdeci">uint32_t gps</div><div class="ttdoc">2 - true if GPS measurements are being fused </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00443">common.h:443</a></div></div>
<div class="ttc" id="class_ekf_html_adedc1dc5e57f319a2b0d70452ea36238"><div class="ttname"><a href="../../dc/d66/class_ekf.html#adedc1dc5e57f319a2b0d70452ea36238">Ekf::check3DMagFusionSuitability</a></div><div class="ttdeci">void check3DMagFusionSuitability()</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00187">mag_control.cpp:187</a></div></div>
<div class="ttc" id="class_ekf_html_aa3557241350622e78d0ef053e28177dc"><div class="ttname"><a href="../../dc/d66/class_ekf.html#aa3557241350622e78d0ef053e28177dc">Ekf::stopMagFusion</a></div><div class="ttdeci">void stopMagFusion()</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d5c/ekf__helper_8cpp_source.html#l01581">ekf_helper.cpp:1581</a></div></div>
<div class="ttc" id="structestimator_1_1mag_sample_html_a32cc19a6ee68ac84aa7b0b91c61800f4"><div class="ttname"><a href="../../da/daf/structestimator_1_1mag_sample.html#a32cc19a6ee68ac84aa7b0b91c61800f4">estimator::magSample::mag</a></div><div class="ttdeci">Vector3f mag</div><div class="ttdoc">NED magnetometer body frame measurements (Gauss) </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00126">common.h:126</a></div></div>
<div class="ttc" id="class_ekf_html_a427d41afde8eb4acb8fc5290bcfbcb9a"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a427d41afde8eb4acb8fc5290bcfbcb9a">Ekf::resetPosition</a></div><div class="ttdeci">bool resetPosition()</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d5c/ekf__helper_8cpp_source.html#l00139">ekf_helper.cpp:139</a></div></div>
<div class="ttc" id="lib_2ecl_2_e_k_f_2common_8h_html_a4794f1aa83200931c08eaa60bbea11c9"><div class="ttname"><a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h.html#a4794f1aa83200931c08eaa60bbea11c9">MAG_FUSE_TYPE_AUTO</a></div><div class="ttdeci">#define MAG_FUSE_TYPE_AUTO</div><div class="ttdoc">The selection of either heading or 3D magnetometer fusion will be automatic. </div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00200">common.h:200</a></div></div>
<div class="ttc" id="class_ekf_html_a80f10caaa9a04cf28d0cd7b26159f067"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a80f10caaa9a04cf28d0cd7b26159f067">Ekf::isMagBiasObservable</a></div><div class="ttdeci">bool isMagBiasObservable() const</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00232">mag_control.cpp:232</a></div></div>
<div class="ttc" id="ekf_8h_html"><div class="ttname"><a href="../../de/d14/ekf_8h.html">ekf.h</a></div><div class="ttdoc">Class for core functions for ekf attitude and position estimator. </div></div>
<div class="ttc" id="class_ekf_html_aa4df90e91dd289376fb0935c9facd7e2"><div class="ttname"><a href="../../dc/d66/class_ekf.html#aa4df90e91dd289376fb0935c9facd7e2">Ekf::isTerrainEstimateValid</a></div><div class="ttdeci">bool isTerrainEstimateValid() const override</div><div class="ttdef"><b>Definition:</b> <a href="../../da/d47/ecl_2_e_k_f_2terrain__estimator_8cpp_source.html#l00287">terrain_estimator.cpp:287</a></div></div>
<div class="ttc" id="lib_2ecl_2_e_k_f_2common_8h_html_a012d3efd061be28ed7a33be5892ac563"><div class="ttname"><a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h.html#a012d3efd061be28ed7a33be5892ac563">MASK_FUSE_DECL</a></div><div class="ttdeci">#define MASK_FUSE_DECL</div><div class="ttdoc">set to true if the declination is always fused as an observation to constrain drift when 3-axis fusio...</div><div class="ttdef"><b>Definition:</b> <a href="../../d5/d60/lib_2ecl_2_e_k_f_2common_8h_source.html#l00186">common.h:186</a></div></div>
<div class="ttc" id="class_ekf_html_a0828d9e222ff448c3686d36d3eafbad3"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a0828d9e222ff448c3686d36d3eafbad3">Ekf::startMagHdgFusion</a></div><div class="ttdeci">void startMagHdgFusion()</div><div class="ttdef"><b>Definition:</b> <a href="../../dd/d5c/ekf__helper_8cpp_source.html#l01602">ekf_helper.cpp:1602</a></div></div>
<div class="ttc" id="class_ekf_html_a9f954eb2ac15055a4932c47c25b71a93"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a9f954eb2ac15055a4932c47c25b71a93">Ekf::_mag_use_not_inhibit_us</a></div><div class="ttdeci">uint64_t _mag_use_not_inhibit_us</div><div class="ttdoc">last system time in usec before magnetometer use was inhibited </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d14/ekf_8h_source.html#l00358">ekf.h:358</a></div></div>
<div class="ttc" id="class_ekf_html_aa243905f7a54a626f293cc031cc44687"><div class="ttname"><a href="../../dc/d66/class_ekf.html#aa243905f7a54a626f293cc031cc44687">Ekf::_mag_data_ready</a></div><div class="ttdeci">bool _mag_data_ready</div><div class="ttdoc">true when new magnetometer data has fallen behind the fusion time horizon and is available to be fuse...</div><div class="ttdef"><b>Definition:</b> <a href="../../de/d14/ekf_8h_source.html#l00318">ekf.h:318</a></div></div>
<div class="ttc" id="class_ekf_html_a3d6387e362409f5306a3a7cfde7d7401"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a3d6387e362409f5306a3a7cfde7d7401">Ekf::isMeasuredMatchingAverageMagStrength</a></div><div class="ttdeci">bool isMeasuredMatchingAverageMagStrength() const</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00308">mag_control.cpp:308</a></div></div>
<div class="ttc" id="class_ekf_html_a4946eb7ab38bacee07201925350f1a29"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a4946eb7ab38bacee07201925350f1a29">Ekf::_mag_bias_observable</a></div><div class="ttdeci">bool _mag_bias_observable</div><div class="ttdoc">true when there is enough rotation to make magnetometer bias errors observable </div><div class="ttdef"><b>Definition:</b> <a href="../../de/d14/ekf_8h_source.html#l00354">ekf.h:354</a></div></div>
<div class="ttc" id="class_estimator_interface_html_aebfe470fa3e331559248f516f03833e1"><div class="ttname"><a href="../../d5/d73/class_estimator_interface.html#aebfe470fa3e331559248f516f03833e1">EstimatorInterface::_mag_sample_delayed</a></div><div class="ttdeci">magSample _mag_sample_delayed</div><div class="ttdef"><b>Definition:</b> <a href="../../d9/d77/estimator__interface_8h_source.html#l00441">estimator_interface.h:441</a></div></div>
<div class="ttc" id="class_ekf_html_a668eac17be299fcd8995f28be4151266"><div class="ttname"><a href="../../dc/d66/class_ekf.html#a668eac17be299fcd8995f28be4151266">Ekf::checkYawAngleObservability</a></div><div class="ttdeci">void checkYawAngleObservability()</div><div class="ttdef"><b>Definition:</b> <a href="../../d8/dbf/mag__control_8cpp_source.html#l00197">mag_control.cpp:197</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="../../dir_c85d3e3c5052e9ad9ce18c6863244a25.html">lib</a></li><li class="navelem"><a class="el" href="../../dir_6f10fbb79da377506552735e446823ce.html">ecl</a></li><li class="navelem"><a class="el" href="../../dir_303783c36f10d27e903dca461e42714a.html">EKF</a></li><li class="navelem"><a class="el" href="../../d8/dbf/mag__control_8cpp.html">mag_control.cpp</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
